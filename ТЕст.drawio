<mxfile host="app.diagrams.net" agent="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Safari/537.36 SberBrowser/31.0.0.0" version="28.2.5">
  <diagram name="Страница — 1" id="YzAyhXTebkGU_6SpY-bU">
    <mxGraphModel dx="1372" dy="742" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="3300" pageHeight="4681" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <UserObject label="&lt;div style=&quot;color: #f8f8f2;background-color: #272822;font-family: Consolas, &#39;Courier New&#39;, monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&quot;&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;Простой скрипт для проверки подключения и авторизации к GigaChat.&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;Использует конфигурацию проекта (`aigw_service.config.APP_CONFIG`) и&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;инициирует запрос к API GigaChat для форсирования авторизации (OAuth к NGW)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;при использовании `GIGACHAT_CREDENTIALS`.&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;Запуск:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&amp;nbsp; &amp;nbsp; poetry run python examples/gigachat_connect_test.py&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;Переменные окружения (в .env):&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&amp;nbsp; &amp;nbsp; LOCAL=True&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&amp;nbsp; &amp;nbsp; GIGACHAT_HOST=gigachat.devices.sberbank.ru&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&amp;nbsp; &amp;nbsp; GIGACHAT_PORT=443&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&amp;nbsp; &amp;nbsp; GIGACHAT_ENDPOINT=/api/v1&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&amp;nbsp; &amp;nbsp; GIGACHAT_CREDENTIALS=... (base64 client_id:client_secret)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&amp;nbsp; &amp;nbsp; GIGACHAT_SCOPE=GIGACHAT_API_CORP (или ваш)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&amp;nbsp; &amp;nbsp; [опц.] GIGACHAT_ACCESS_TOKEN= (оставьте пустым, чтобы проверить OAuth)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&amp;nbsp; &amp;nbsp; [опц.] GIGACHAT_OAUTH_URL=https://ngw.devices.sberbank.ru:9443/api/v2/oauth&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&quot;&quot;&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;import&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; os&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;import&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; sys&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;from&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; typing &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;import&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; Any, Dict&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;from&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; dotenv &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;import&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; load_dotenv&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;def&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #a6e22e;&quot;&gt;main&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;() -&amp;gt; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;int&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #88846f;&quot;&gt;# Загружаем .env из корня проекта&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; project_root &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; os.path.abspath(os.path.join(os.path.dirname(__file__), os.pardir))&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; dotenv_path &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; os.path.join(project_root, &lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;.env&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; load_dotenv(dotenv_path)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #88846f;&quot;&gt;# Импортируем после загрузки .env, чтобы конфиг подтянул значения&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;from&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; aigw_service.config &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;import&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;APP_CONFIG&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;except&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;Exception&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;as&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; e:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;&quot;&gt;print&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;[ERROR] Не удалось импортировать конфиг приложения: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;e&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;1&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #88846f;&quot;&gt;# Базовые параметры клиента&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; base_params: Dict[&lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;str&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;, Any] &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;dict&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;APP_CONFIG&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;.gigachat.base_params)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #88846f;&quot;&gt;# Поддержка кастомного OAuth URL, если клиент принимает этот параметр&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; oauth_url &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; os.getenv(&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;GIGACHAT_OAUTH_URL&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; oauth_url:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #88846f;&quot;&gt;# Часто параметр называется oauth_url в langchain-gigachat&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; base_params.setdefault(&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;oauth_url&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;, oauth_url)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #88846f;&quot;&gt;# Явно уменьшим таймаут для теста&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; base_params.setdefault(&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;timeout&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;30&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #88846f;&quot;&gt;# Отладочный вывод&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;&quot;&gt;print&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;== GigaChat connection test ==&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;&quot;&gt;print&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;Base URL: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{APP_CONFIG&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;.gigachat.gigachat_base_url&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;&quot;&gt;print&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;Use token auth: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{APP_CONFIG&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;.gigachat.use_token_auth&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;&quot;&gt;print&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;Has access token: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;bool&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;APP_CONFIG&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;.gigachat.gigachat_access_token)&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;&quot;&gt;print&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;Has credentials: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;bool&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;APP_CONFIG&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;.gigachat.gigachat_credentials)&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; oauth_url:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;&quot;&gt;print&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;OAuth URL: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;oauth_url&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #88846f;&quot;&gt;# Импортируем клиент GigaChat из пакета langchain_gigachat&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;from&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; langchain_gigachat &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;import&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; GigaChat&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;except&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;Exception&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;as&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; e:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;&quot;&gt;print&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;(&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;[ERROR] Не удалось импортировать GigaChat из langchain_gigachat: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;e&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;\n&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;Убедитесь, что зависимости установлены: poetry install&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; )&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;1&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; client &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; GigaChat(&lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;**&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;base_params)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #88846f;&quot;&gt;# Вариант 1: получить список моделей (минимальный запрос, триггерит OAuth)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; models &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; client.get_models()&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;&quot;&gt;print&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;Models received: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #66d9ef;&quot;&gt;len&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;(models)&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #88846f;&quot;&gt;# Вариант 2: сделать короткий вызов чата&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; answer &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; client.invoke(&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;ping&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; content &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;&quot;&gt;getattr&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;(answer, &lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;content&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;str&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;(answer))&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;&quot;&gt;print&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;Invoke OK. Answer: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;content[:&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;120&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;]&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;except&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;Exception&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;as&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; e:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;&quot;&gt;print&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;[WARN] Invoke failed (не критично для проверки OAuth): &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;e&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;&quot;&gt;print&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;[OK] Подключение к GigaChat установлено.&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;0&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;except&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;Exception&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;as&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; e:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;&quot;&gt;print&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;[ERROR] Ошибка подключения к GigaChat: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;e&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;2&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; __name__ &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;==&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;__main__&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; sys.exit(main())&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;/div&gt;" link="&lt;div style=&quot;color: #f8f8f2;background-color: #272822;font-family: Consolas, &#39;Courier New&#39;, monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&quot;&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;Простой скрипт для проверки подключения и авторизации к GigaChat.&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;Использует конфигурацию проекта (`aigw_service.config.APP_CONFIG`) и&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;инициирует запрос к API GigaChat для форсирования авторизации (OAuth к NGW)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;при использовании `GIGACHAT_CREDENTIALS`.&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;Запуск:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&amp;nbsp; &amp;nbsp; poetry run python examples/gigachat_connect_test.py&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;Переменные окружения (в .env):&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&amp;nbsp; &amp;nbsp; LOCAL=True&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&amp;nbsp; &amp;nbsp; GIGACHAT_HOST=gigachat.devices.sberbank.ru&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&amp;nbsp; &amp;nbsp; GIGACHAT_PORT=443&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&amp;nbsp; &amp;nbsp; GIGACHAT_ENDPOINT=/api/v1&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&amp;nbsp; &amp;nbsp; GIGACHAT_CREDENTIALS=... (base64 client_id:client_secret)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&amp;nbsp; &amp;nbsp; GIGACHAT_SCOPE=GIGACHAT_API_CORP (или ваш)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&amp;nbsp; &amp;nbsp; [опц.] GIGACHAT_ACCESS_TOKEN= (оставьте пустым, чтобы проверить OAuth)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&amp;nbsp; &amp;nbsp; [опц.] GIGACHAT_OAUTH_URL=https://ngw.devices.sberbank.ru:9443/api/v2/oauth&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&quot;&quot;&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;import&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; os&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;import&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; sys&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;from&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; typing &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;import&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; Any, Dict&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;from&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; dotenv &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;import&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; load_dotenv&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;def&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #a6e22e;&quot;&gt;main&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;() -&amp;gt; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;int&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #88846f;&quot;&gt;# Загружаем .env из корня проекта&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; project_root &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; os.path.abspath(os.path.join(os.path.dirname(__file__), os.pardir))&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; dotenv_path &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; os.path.join(project_root, &lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;.env&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; load_dotenv(dotenv_path)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #88846f;&quot;&gt;# Импортируем после загрузки .env, чтобы конфиг подтянул значения&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;from&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; aigw_service.config &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;import&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;APP_CONFIG&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;except&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;Exception&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;as&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; e:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;&quot;&gt;print&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;[ERROR] Не удалось импортировать конфиг приложения: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;e&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;1&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #88846f;&quot;&gt;# Базовые параметры клиента&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; base_params: Dict[&lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;str&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;, Any] &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;dict&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;APP_CONFIG&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;.gigachat.base_params)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #88846f;&quot;&gt;# Поддержка кастомного OAuth URL, если клиент принимает этот параметр&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; oauth_url &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; os.getenv(&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;GIGACHAT_OAUTH_URL&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; oauth_url:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #88846f;&quot;&gt;# Часто параметр называется oauth_url в langchain-gigachat&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; base_params.setdefault(&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;oauth_url&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;, oauth_url)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #88846f;&quot;&gt;# Явно уменьшим таймаут для теста&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; base_params.setdefault(&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;timeout&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;30&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #88846f;&quot;&gt;# Отладочный вывод&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;&quot;&gt;print&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;== GigaChat connection test ==&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;&quot;&gt;print&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;Base URL: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{APP_CONFIG&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;.gigachat.gigachat_base_url&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;&quot;&gt;print&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;Use token auth: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{APP_CONFIG&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;.gigachat.use_token_auth&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;&quot;&gt;print&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;Has access token: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;bool&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;APP_CONFIG&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;.gigachat.gigachat_access_token)&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;&quot;&gt;print&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;Has credentials: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;bool&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;APP_CONFIG&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;.gigachat.gigachat_credentials)&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; oauth_url:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;&quot;&gt;print&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;OAuth URL: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;oauth_url&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #88846f;&quot;&gt;# Импортируем клиент GigaChat из пакета langchain_gigachat&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;from&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; langchain_gigachat &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;import&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; GigaChat&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;except&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;Exception&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;as&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; e:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;&quot;&gt;print&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;(&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;[ERROR] Не удалось импортировать GigaChat из langchain_gigachat: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;e&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;\n&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;Убедитесь, что зависимости установлены: poetry install&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; )&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;1&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; client &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; GigaChat(&lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;**&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;base_params)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #88846f;&quot;&gt;# Вариант 1: получить список моделей (минимальный запрос, триггерит OAuth)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; models &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; client.get_models()&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;&quot;&gt;print&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;Models received: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #66d9ef;&quot;&gt;len&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;(models)&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #88846f;&quot;&gt;# Вариант 2: сделать короткий вызов чата&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; answer &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; client.invoke(&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;ping&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; content &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;&quot;&gt;getattr&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;(answer, &lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;content&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;str&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;(answer))&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;&quot;&gt;print&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;Invoke OK. Answer: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;content[:&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;120&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;]&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;except&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;Exception&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;as&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; e:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;&quot;&gt;print&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;[WARN] Invoke failed (не критично для проверки OAuth): &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;e&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;&quot;&gt;print&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;[OK] Подключение к GigaChat установлено.&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;0&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;except&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;Exception&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;as&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; e:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;&quot;&gt;print&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;[ERROR] Ошибка подключения к GigaChat: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;e&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;2&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; __name__ &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;==&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;__main__&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; sys.exit(main())&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;/div&gt;" id="6TUQVXqevLIUsPXIy-Aa-1">
          <mxCell style="text;whiteSpace=wrap;html=1;" parent="1" vertex="1">
            <mxGeometry x="260" y="80" width="560" height="1890" as="geometry" />
          </mxCell>
        </UserObject>
        <UserObject label="20734976@sigma.sbrf.ru@SZB-WSN-0002258:~/kib-vas-agent/kib-vas-agent$ poetry run examples/gigachat_connect_test.py &#xa;&#xa;&#xa;[Errno 13] Permission denied: &#39;examples/gigachat_connect_test.py&#39;" link="20734976@sigma.sbrf.ru@SZB-WSN-0002258:~/kib-vas-agent/kib-vas-agent$ poetry run examples/gigachat_connect_test.py &#xa;&#xa;&#xa;[Errno 13] Permission denied: &#39;examples/gigachat_connect_test.py&#39;" id="DSNMYpRrBqVaP7X5KKwe-1">
          <mxCell style="text;whiteSpace=wrap;" parent="1" vertex="1">
            <mxGeometry x="1050" y="180" width="560" height="100" as="geometry" />
          </mxCell>
        </UserObject>
        <UserObject label="import uuid&#xa;import os&#xa;import re&#xa;import requests&#xa;from datetime import datetime&#xa;from core.logging.logger_utils import log&#xa;from scenarios.user.user_model import User&#xa;&#xa;&#xa;&#xa;&#xa;def run_request(user: User, service_id: str = &quot;faq&quot;) -&gt; None:&#xa;    &quot;&quot;&quot;Отправляет запрос к серверу в соответствии с новым форматом&quot;&quot;&quot;&#xa;    HEADERS = {&#xa;        &#39;accept&#39;: &#39;application/json&#39;,&#xa;        &#39;Content-Type&#39;: &#39;application/json&#39;,&#xa;    }&#xa;    external_uuid = str(uuid.uuid4())&#xa;    SOURCE_ID = os.getenv(&#39;SOURCE_ID&#39;, &#39;957ec5e0-a331-4da8-9fa7-15a1c4d86035&#39;)&#xa;    INDEX_ID_FAQ = os.getenv(&#39;INDEX_ID&#39;, &#39;9870147f-a646-4421-aa96-aa8960c821fb_dkpp_index_faq_0_1_0&#39;)&#xa;    INDEX_ID_SOURCES = os.getenv(&#39;INDEX_ID_SOURCES&#39;, &#39;9870147f-a646-4421-aa96-aa8960c821fb_dkpp_index_nofaq_0_2_1&#39;)&#xa;    URL = os.getenv(&#39;IDP_API&#39;, &#39;sm.apps.dev-terra000003-ids.ocp.delta.sbrf.ru&#39;)&#xa;    MODEL_NAME = &quot;GigaChat-2-Max&quot;&#xa;&#xa;&#xa;    uri = r&quot;http://&quot; + URL + r&quot;/sync/skill/universal_search&quot;&#xa;&#xa;&#xa;        &#xa;    search_config = {&#xa;    &quot;agent_type&quot;: &quot;universal&quot;,&#xa;    &quot;agent_configuration&quot;: {&#xa;        &quot;index_type&quot;: &quot;opensearch&quot;,&#xa;        &quot;data_sources&quot;: [&#xa;            {&#xa;                &quot;index_id&quot;: INDEX_ID_SOURCES&#xa;            }&#xa;        ],&#xa;        &quot;data_sources_faq&quot;: [&#xa;            {&#xa;                &quot;index_id&quot;: INDEX_ID_FAQ&#xa;            }&#xa;        ],&#xa;        &quot;query_rewriter&quot;: {&#xa;            &quot;enabled&quot;: False&#xa;        },&#xa;        &quot;reranker&quot;: {&#xa;            &quot;enabled&quot;: False&#xa;        },&#xa;        &quot;reranker_faq&quot;: {&#xa;            &quot;enabled&quot;: False&#xa;        },&#xa;        &quot;retriever&quot;: {&#xa;            &quot;bm25_weight&quot;: 0.3,&#xa;            &quot;global_size&quot;: 100,&#xa;            &quot;size&quot;: 10,&#xa;            &quot;embedder&quot;: {&#xa;                &quot;model_name&quot;: &quot;gigachat&quot;&#xa;            }&#xa;        },&#xa;        &quot;retriever_faq&quot;: {&#xa;            &quot;bm25_weight&quot;: 0.2,&#xa;            &quot;global_size&quot;: 100,&#xa;            &quot;size&quot;: 10,&#xa;            &quot;embedder&quot;: {&#xa;                &quot;model_name&quot;: &quot;gigachat&quot;&#xa;            }&#xa;        },&#xa;        &quot;context_expansion&quot;: {&#xa;            &quot;enabled&quot;: False,&#xa;            &quot;chapter_aggregation&quot;: True,&#xa;            &quot;max_tokens&quot;: 2000&#xa;        },&#xa;        &quot;qa&quot;: {&#xa;            &quot;enabled&quot;: True,&#xa;            &quot;qa_scenario&quot;: &quot;stuff&quot;,&#xa;            &quot;model_name&quot;: MODEL_NAME,&#xa;            &quot;temperature&quot;: 0.1,&#xa;            &quot;top_p&quot;: 0,&#xa;            &quot;repetition_penalty&quot;: 1&#xa;        },&#xa;        &quot;sources&quot;: {&#xa;            &quot;enabled&quot;: True,&#xa;            &quot;source_type&quot;: &quot;passage&quot;&#xa;        },&#xa;        &quot;inline_sources&quot;: {&#xa;            &quot;enabled&quot;: True,&#xa;            &quot;format&quot;: &quot;index_caret&quot;,&#xa;            &quot;source_type&quot;: &quot;passage&quot;&#xa;        }&#xa;    }&#xa;}&#xa;&#xa;&#xa;&#xa;&#xa;    chat = {&#xa;        &quot;request_type&quot;: &quot;chat&quot;,&#xa;        &quot;request&quot;: {&#xa;            &quot;messages&quot;: [&#xa;            {&#xa;                &quot;role&quot;: &quot;user&quot;,&#xa;                &quot;content&quot;: user.variables.get(&#39;IDP_question&#39;, &#39;&#39;),&#xa;            }&#xa;        ],&#xa;        }&#xa;    }&#xa;&#xa;&#xa;    request_body = {&#xa;        &quot;meta&quot;: {&quot;external_uuid&quot;: external_uuid, &quot;source_uuid&quot;: SOURCE_ID},&#xa;        &quot;message&quot;: chat,&#xa;        &quot;path&quot;: &quot;/predict&quot;,&#xa;        &quot;timeout&quot;: 600,&#xa;        &quot;configuration&quot;: search_config&#xa;    }&#xa;&#xa;&#xa;    try:&#xa;        log(f&quot;ПОПЫТКА ОТПРАВИТЬ ЗАПРОС НА УНИВЕРСАЛЬНЫЙ СКИЛЛ IDP {uri}, {str(HEADERS)}, {str(request_body)}&quot;)&#xa;        response = requests.post(&#xa;            uri,&#xa;            headers=HEADERS,&#xa;            json=request_body,&#xa;            verify=True&#xa;        )&#xa;&#xa;&#xa;        ## Замена численных источников на названия документов&#xa;&#xa;&#xa;        revert_replacements = {&#xa;            &#39;_SPACE_&#39;: &#39; &#39;,&#xa;            &#39;_COMMA_&#39;: &#39;,&#39;,&#xa;            &#39;_DOT_&#39;: &#39;.&#39;,&#xa;            &#39;_EXCLAMATIONMARK_&#39;: &#39;!&#39;,&#xa;            &#39;_QUESTIONMARK_&#39;: &#39;?&#39;,&#xa;            &#39;_COLON_&#39;: &#39;:&#39;,&#xa;            &#39;_SEMICOLON_&#39;: &#39;;&#39;,&#xa;            &#39;_HYPHEN_&#39;: &#39;-&#39;,&#xa;            &#39;_UNDERSCORE_&#39;: &#39;_&#39;,&#xa;            &#39;_LEFTPARENTHESIS_&#39;: &#39;(&#39;,&#xa;            &#39;_RIGHTPARENTHESIS_&#39;: &#39;)&#39;,&#xa;            &#39;_LEFTBRACKET_&#39;: &#39;[&#39;,&#xa;            &#39;_RIGHTBRACKET_&#39;: &#39;]&#39;,&#xa;            &#39;_LEFTBRACE_&#39;: &#39;{&#39;,&#xa;            &#39;_RIGHTBRACE_&#39;: &#39;}&#39;,&#xa;            &#39;_APOSTROPHE_&#39;: &quot;&#39;&quot;,&#xa;            &#39;_QUOTATIONMARK_&#39;: &#39;&quot;&#39;,&#xa;            &#39;_SLASH_&#39;: &#39;/&#39;,&#xa;            &#39;_BACKSLASH_&#39;: &#39;\\&#39;,&#xa;            &#39;_VERTICALBAR_&#39;: &#39;|&#39;,&#xa;            &#39;_ATSIGN_&#39;: &#39;@&#39;,&#xa;            &#39;_HASHTAG_&#39;: &#39;#&#39;,&#xa;            &#39;_DOLLARSIGN_&#39;: &#39;$&#39;,&#xa;            &#39;_PERCENTSIGN_&#39;: &#39;%&#39;,&#xa;            &#39;_CARET_&#39;: &#39;^&#39;,&#xa;            &#39;_AMPERSAND_&#39;: &#39;&amp;&#39;,&#xa;            &#39;_ASTERISK_&#39;: &#39;*&#39;,&#xa;            &#39;_PLUSSIGN_&#39;: &#39;+&#39;,&#xa;            &#39;_EQUALSIGN_&#39;: &#39;=&#39;,&#xa;            &#39;_LESSTHAN_&#39;: &#39;&lt;&#39;,&#xa;            &#39;_GREATERTHAN_&#39;: &#39;&gt;&#39;,&#xa;            &#39;_GRAVEACCENT_&#39;: &#39;`&#39;,&#xa;            &#39;_TILDE_&#39;: &#39;~&#39;,&#xa;            &#39;_NUMBERSYMB_&#39;: &#39;№&#39;,&#xa;        }&#xa;&#xa;&#xa;        pattern = re.compile(&#39;|&#39;.join(re.escape(char) for char in revert_replacements.keys()))&#xa;&#xa;&#xa;        def replacer(match):&#xa;            return revert_replacements[match.group(0)]&#xa;&#xa;&#xa;        response_clean = response.json()[&#39;result&#39;][&#39;response&#39;][&#39;messages&#39;][-1]&#xa;        server_answer_content = response_clean[&#39;content&#39;]&#xa;        # inline_sources = response_clean[&#39;faq_sources&#39;]&#xa;        # for i in range(len(inline_sources)):&#xa;        #     replace_on_raw = inline_sources[i][&#39;metadata&#39;][&#39;tags&#39;][0]&#xa;        #     replace_on = pattern.sub(replacer, replace_on_raw)[1:]&#xa;        #     server_answer_content = server_answer_content.replace(f&#39;[^{i+1}^]&#39;, f&quot;[{replace_on}]&quot;)&#xa;&#xa;&#xa;        inline_sources = response.json()[&#39;result&#39;][&#39;response&#39;][&#39;messages&#39;][-1][&#39;inline_sources&#39;]&#xa;        for i, inl_src in enumerate(inline_sources):&#xa;            replace_on = &quot;&quot;&#xa;            if inl_src[&#39;source_type&#39;] == &#39;faq&#39;:&#xa;                replace_on_raw = inl_src[&#39;source&#39;][&#39;metadata&#39;][&#39;tags&#39;][0]&#xa;                replace_on = &#39;[&#39; + pattern.sub(replacer, replace_on_raw)[1:] + &#39;]&#39;&#xa;            elif inl_src[&#39;source_type&#39;] == &#39;passage&#39;:&#xa;                path_elements = inl_src[&#39;source&#39;][&#39;metadata&#39;][&#39;breadcrumbs&#39;].split(&#39;/&#39;)&#xa;                if len(path_elements) &gt; 1:&#xa;                    replace_on = &#39;[&#39; + path_elements[-2] + &#39;]&#39;&#xa;            server_answer_content = server_answer_content.replace(f&#39;[^{i+1}^]&#39;, f&quot;{replace_on}&quot;)&#xa;&#xa;&#xa;&#xa;&#xa;        log(f&quot;ПОЛУЧЕННЫЙ ОТВЕТ С IDP {server_answer_content}&quot;)&#xa;        user.variables.set(&#39;IDP_answer&#39;, server_answer_content)&#xa;        log(f&quot;Успешный запрос к {uri}. Ответ обработан.&quot;, level=&quot;INFO&quot;)&#xa;        log(f&quot;ПОЛУЧЕННЫЙ ОТВЕТ С IDP {server_answer_content}&quot;)&#xa;        user.variables.set(&#39;IDP_answer&#39;, server_answer_content)&#xa;        log(f&quot;Успешный запрос к {uri}. Ответ обработан.&quot;, level=&quot;INFO&quot;)&#xa;&#xa;&#xa;    except requests.RequestException as e:&#xa;        user.variables.set(&#39;IDP_answer&#39;, &#39;Ошибка при обработке запроса&#39;)&#xa;        log(f&quot;Ответ от IDP: {response.text}&quot;, level=&quot;INFO&quot;)&#xa;        log(f&quot;Ошибка запроса к {uri}: {str(e)}&quot;, level=&quot;ERROR&quot;)&#xa;    except (KeyError, IndexError, ValueError) as e:&#xa;        user.variables.set(&#39;IDP_answer&#39;, &#39;Ошибка при обработке ответа&#39;)&#xa;        log(f&quot;Ответ от IDP: {response.text}&quot;, level=&quot;INFO&quot;)&#xa;        log(f&quot;Ошибка обработки ответа: {str(e)}&quot;, level=&quot;ERROR&quot;)&#xa;&#xa;&#xa;if __name__ == &#39;__main__&#39;:&#xa;    questions = [&quot;Какие манипуляции с долгом возможны в отчетности?&quot;,&#xa;&quot;По какому участнику сделки требуется построение прогноза движения денежных средств при установлении ИР на Консолидированную Группу?&quot;,&#xa;&quot;На какой срок строятся будущие денежные потоки?&quot;,&#xa;&quot;Как определить, что деятельность носит сезонный характер?&quot;,&#xa;&quot;Можно ли строить будущие денежные потоки в иностранной валюте?&quot;,&#xa;&quot;Относится ли к прочим изменениям увеличение срока действующей банковской гарантии в пределах срока лимита ЕДБГ без увеличения срока действия лимита ЕДБГ?&quot;,&#xa;&quot;Требуется ли проверка Fraud-риска по техническим изменениям?&quot;,&#xa;&quot;Является ли прочим изменением продление периода выборки по сделке УФН?&quot;,&#xa;&quot;Финансирует ли Банк казино?&quot;,&#xa;&quot;Особенности финансирования по договорам простого товарищества&quot;,&#xa;&quot;Может ли банк финансировать некоммерческие организации?&quot;]&#xa;    for question in questions:&#xa;        run_request(question)&#xa;Это скрипт для отправки запроса в сервис.&#xa;Нужно сделать аналогичный, для отправки на такой API:&#xa;@router.post(&#xa;    &quot;/idp_search&quot;,&#xa;    status_code=status.HTTP_200_OK,&#xa;    response_model=schemas.IDPSearchResponse,&#xa;    responses={&#xa;        status.HTTP_424_FAILED_DEPENDENCY: {&#xa;            &quot;description&quot;: &quot;Ошибка при взаимодействии с IDP системой&quot;,&#xa;            &quot;model&quot;: schemas.IDPErrorResponse,&#xa;        },&#xa;    },&#xa;)&#xa;async def idp_search(&#xa;    request: schemas.IDPSearchRequest,&#xa;    headers: dict = Depends(common_headers),&#xa;):&#xa;    &quot;&quot;&quot;&#xa;    Поиск информации в IDP (Intelligent Data Platform).&#xa;    &#xa;    Этот endpoint позволяет выполнить поиск информации в корпоративной базе знаний &#xa;    через IDP API. Система автоматически обрабатывает запрос, выполняет поиск&#xa;    по документам и возвращает ответ с ссылками на источники.&#xa;    &quot;&quot;&quot;&#xa;    logger.info(f&quot;Processing IDP search request: &#39;{request.question[:100]}...&#39;&quot;)&#xa;    &#xa;    # Отправляем запрос через IDP сервис&#xa;    answer, response_time, error_msg, external_uuid = await idp_service.search(request.question)&#xa;    &#xa;    if error_msg:&#xa;        logger.error(f&quot;IDP search failed: {error_msg}&quot;)&#xa;        return JSONResponse(&#xa;            status_code=status.HTTP_424_FAILED_DEPENDENCY,&#xa;            content=schemas.IDPErrorResponse(&#xa;                error_description=f&quot;Ошибка при обращении к IDP: {error_msg}&quot;,&#xa;                error_code=error_msg,&#xa;                response_time=response_time,&#xa;            ).model_dump(),&#xa;        )&#xa;    &#xa;    logger.info(f&quot;IDP search completed in {response_time:.2f}s&quot;)&#xa;    return schemas.IDPSearchResponse(&#xa;        answer=answer,&#xa;        response_time=response_time,&#xa;        external_uuid=external_uuid,&#xa;    )&#xa;&#xa;&#xa;# IDP Schemas&#xa;&#xa;&#xa;class IDPSearchRequest(BaseModel):&#xa;    &quot;&quot;&quot;Тело запроса для IDP поиска&quot;&quot;&quot;&#xa;&#xa;&#xa;    question: str = Field(&#xa;        description=&quot;Вопрос для поиска в IDP (Intelligent Data Platform)&quot;,&#xa;        min_length=4,&#xa;        examples=[&#xa;            &quot;Какие манипуляции с долгом возможны в отчетности?&quot;,&#xa;            &quot;По какому участнику сделки требуется построение прогноза движения денежных средств?&quot;,&#xa;            &quot;На какой срок строятся будущие денежные потоки?&quot;&#xa;        ],&#xa;    )&#xa;&#xa;&#xa;&#xa;&#xa;class IDPSearchResponse(BaseModel):&#xa;    &quot;&quot;&quot;Ответ для IDP поиска&quot;&quot;&quot;&#xa;&#xa;&#xa;    answer: str = Field(&#xa;        description=&quot;Ответ от IDP с информацией из базы знаний и ссылками на источники&quot;,&#xa;        examples=[&#xa;            &quot;Согласно документации [Руководство по кредитным операциям], манипуляции с долгом включают реструктуризацию, рефинансирование и списание безнадежной задолженности.&quot;&#xa;        ],&#xa;    )&#xa;    response_time: float = Field(&#xa;        description=&quot;Время ответа в секундах&quot;,&#xa;        examples=[3.24],&#xa;    )&#xa;    external_uuid: str = Field(&#xa;        description=&quot;Уникальный идентификатор запроса&quot;,&#xa;        examples=[&quot;550e8400-e29b-41d4-a716-446655440000&quot;],&#xa;    )&#xa;&#xa;&#xa;&#xa;&#xa;class IDPErrorResponse(BaseModel):&#xa;    &quot;&quot;&quot;Ошибка при работе с IDP&quot;&quot;&quot;&#xa;&#xa;&#xa;    error_description: str = Field(&#xa;        description=&quot;Описание ошибки при обращении к IDP&quot;,&#xa;        examples=[&#xa;            &quot;Ошибка при обработке запроса к IDP&quot;,&#xa;            &quot;Timeout при обращении к IDP API&quot;,&#xa;            &quot;Ошибка при обработке ответа от IDP&quot;&#xa;        ],&#xa;    )&#xa;    error_code: str = Field(&#xa;        description=&quot;Код ошибки&quot;,&#xa;        examples=[&quot;IDP_REQUEST_ERROR&quot;, &quot;IDP_TIMEOUT_ERROR&quot;, &quot;IDP_RESPONSE_ERROR&quot;],&#xa;    )&#xa;    response_time: Optional[float] = Field(&#xa;        description=&quot;Время ответа в секундах (если доступно)&quot;,&#xa;        examples=[5.0],&#xa;        default=None,&#xa;    )" link="import uuid&#xa;import os&#xa;import re&#xa;import requests&#xa;from datetime import datetime&#xa;from core.logging.logger_utils import log&#xa;from scenarios.user.user_model import User&#xa;&#xa;&#xa;&#xa;&#xa;def run_request(user: User, service_id: str = &quot;faq&quot;) -&gt; None:&#xa;    &quot;&quot;&quot;Отправляет запрос к серверу в соответствии с новым форматом&quot;&quot;&quot;&#xa;    HEADERS = {&#xa;        &#39;accept&#39;: &#39;application/json&#39;,&#xa;        &#39;Content-Type&#39;: &#39;application/json&#39;,&#xa;    }&#xa;    external_uuid = str(uuid.uuid4())&#xa;    SOURCE_ID = os.getenv(&#39;SOURCE_ID&#39;, &#39;957ec5e0-a331-4da8-9fa7-15a1c4d86035&#39;)&#xa;    INDEX_ID_FAQ = os.getenv(&#39;INDEX_ID&#39;, &#39;9870147f-a646-4421-aa96-aa8960c821fb_dkpp_index_faq_0_1_0&#39;)&#xa;    INDEX_ID_SOURCES = os.getenv(&#39;INDEX_ID_SOURCES&#39;, &#39;9870147f-a646-4421-aa96-aa8960c821fb_dkpp_index_nofaq_0_2_1&#39;)&#xa;    URL = os.getenv(&#39;IDP_API&#39;, &#39;sm.apps.dev-terra000003-ids.ocp.delta.sbrf.ru&#39;)&#xa;    MODEL_NAME = &quot;GigaChat-2-Max&quot;&#xa;&#xa;&#xa;    uri = r&quot;http://&quot; + URL + r&quot;/sync/skill/universal_search&quot;&#xa;&#xa;&#xa;        &#xa;    search_config = {&#xa;    &quot;agent_type&quot;: &quot;universal&quot;,&#xa;    &quot;agent_configuration&quot;: {&#xa;        &quot;index_type&quot;: &quot;opensearch&quot;,&#xa;        &quot;data_sources&quot;: [&#xa;            {&#xa;                &quot;index_id&quot;: INDEX_ID_SOURCES&#xa;            }&#xa;        ],&#xa;        &quot;data_sources_faq&quot;: [&#xa;            {&#xa;                &quot;index_id&quot;: INDEX_ID_FAQ&#xa;            }&#xa;        ],&#xa;        &quot;query_rewriter&quot;: {&#xa;            &quot;enabled&quot;: False&#xa;        },&#xa;        &quot;reranker&quot;: {&#xa;            &quot;enabled&quot;: False&#xa;        },&#xa;        &quot;reranker_faq&quot;: {&#xa;            &quot;enabled&quot;: False&#xa;        },&#xa;        &quot;retriever&quot;: {&#xa;            &quot;bm25_weight&quot;: 0.3,&#xa;            &quot;global_size&quot;: 100,&#xa;            &quot;size&quot;: 10,&#xa;            &quot;embedder&quot;: {&#xa;                &quot;model_name&quot;: &quot;gigachat&quot;&#xa;            }&#xa;        },&#xa;        &quot;retriever_faq&quot;: {&#xa;            &quot;bm25_weight&quot;: 0.2,&#xa;            &quot;global_size&quot;: 100,&#xa;            &quot;size&quot;: 10,&#xa;            &quot;embedder&quot;: {&#xa;                &quot;model_name&quot;: &quot;gigachat&quot;&#xa;            }&#xa;        },&#xa;        &quot;context_expansion&quot;: {&#xa;            &quot;enabled&quot;: False,&#xa;            &quot;chapter_aggregation&quot;: True,&#xa;            &quot;max_tokens&quot;: 2000&#xa;        },&#xa;        &quot;qa&quot;: {&#xa;            &quot;enabled&quot;: True,&#xa;            &quot;qa_scenario&quot;: &quot;stuff&quot;,&#xa;            &quot;model_name&quot;: MODEL_NAME,&#xa;            &quot;temperature&quot;: 0.1,&#xa;            &quot;top_p&quot;: 0,&#xa;            &quot;repetition_penalty&quot;: 1&#xa;        },&#xa;        &quot;sources&quot;: {&#xa;            &quot;enabled&quot;: True,&#xa;            &quot;source_type&quot;: &quot;passage&quot;&#xa;        },&#xa;        &quot;inline_sources&quot;: {&#xa;            &quot;enabled&quot;: True,&#xa;            &quot;format&quot;: &quot;index_caret&quot;,&#xa;            &quot;source_type&quot;: &quot;passage&quot;&#xa;        }&#xa;    }&#xa;}&#xa;&#xa;&#xa;&#xa;&#xa;    chat = {&#xa;        &quot;request_type&quot;: &quot;chat&quot;,&#xa;        &quot;request&quot;: {&#xa;            &quot;messages&quot;: [&#xa;            {&#xa;                &quot;role&quot;: &quot;user&quot;,&#xa;                &quot;content&quot;: user.variables.get(&#39;IDP_question&#39;, &#39;&#39;),&#xa;            }&#xa;        ],&#xa;        }&#xa;    }&#xa;&#xa;&#xa;    request_body = {&#xa;        &quot;meta&quot;: {&quot;external_uuid&quot;: external_uuid, &quot;source_uuid&quot;: SOURCE_ID},&#xa;        &quot;message&quot;: chat,&#xa;        &quot;path&quot;: &quot;/predict&quot;,&#xa;        &quot;timeout&quot;: 600,&#xa;        &quot;configuration&quot;: search_config&#xa;    }&#xa;&#xa;&#xa;    try:&#xa;        log(f&quot;ПОПЫТКА ОТПРАВИТЬ ЗАПРОС НА УНИВЕРСАЛЬНЫЙ СКИЛЛ IDP {uri}, {str(HEADERS)}, {str(request_body)}&quot;)&#xa;        response = requests.post(&#xa;            uri,&#xa;            headers=HEADERS,&#xa;            json=request_body,&#xa;            verify=True&#xa;        )&#xa;&#xa;&#xa;        ## Замена численных источников на названия документов&#xa;&#xa;&#xa;        revert_replacements = {&#xa;            &#39;_SPACE_&#39;: &#39; &#39;,&#xa;            &#39;_COMMA_&#39;: &#39;,&#39;,&#xa;            &#39;_DOT_&#39;: &#39;.&#39;,&#xa;            &#39;_EXCLAMATIONMARK_&#39;: &#39;!&#39;,&#xa;            &#39;_QUESTIONMARK_&#39;: &#39;?&#39;,&#xa;            &#39;_COLON_&#39;: &#39;:&#39;,&#xa;            &#39;_SEMICOLON_&#39;: &#39;;&#39;,&#xa;            &#39;_HYPHEN_&#39;: &#39;-&#39;,&#xa;            &#39;_UNDERSCORE_&#39;: &#39;_&#39;,&#xa;            &#39;_LEFTPARENTHESIS_&#39;: &#39;(&#39;,&#xa;            &#39;_RIGHTPARENTHESIS_&#39;: &#39;)&#39;,&#xa;            &#39;_LEFTBRACKET_&#39;: &#39;[&#39;,&#xa;            &#39;_RIGHTBRACKET_&#39;: &#39;]&#39;,&#xa;            &#39;_LEFTBRACE_&#39;: &#39;{&#39;,&#xa;            &#39;_RIGHTBRACE_&#39;: &#39;}&#39;,&#xa;            &#39;_APOSTROPHE_&#39;: &quot;&#39;&quot;,&#xa;            &#39;_QUOTATIONMARK_&#39;: &#39;&quot;&#39;,&#xa;            &#39;_SLASH_&#39;: &#39;/&#39;,&#xa;            &#39;_BACKSLASH_&#39;: &#39;\\&#39;,&#xa;            &#39;_VERTICALBAR_&#39;: &#39;|&#39;,&#xa;            &#39;_ATSIGN_&#39;: &#39;@&#39;,&#xa;            &#39;_HASHTAG_&#39;: &#39;#&#39;,&#xa;            &#39;_DOLLARSIGN_&#39;: &#39;$&#39;,&#xa;            &#39;_PERCENTSIGN_&#39;: &#39;%&#39;,&#xa;            &#39;_CARET_&#39;: &#39;^&#39;,&#xa;            &#39;_AMPERSAND_&#39;: &#39;&amp;&#39;,&#xa;            &#39;_ASTERISK_&#39;: &#39;*&#39;,&#xa;            &#39;_PLUSSIGN_&#39;: &#39;+&#39;,&#xa;            &#39;_EQUALSIGN_&#39;: &#39;=&#39;,&#xa;            &#39;_LESSTHAN_&#39;: &#39;&lt;&#39;,&#xa;            &#39;_GREATERTHAN_&#39;: &#39;&gt;&#39;,&#xa;            &#39;_GRAVEACCENT_&#39;: &#39;`&#39;,&#xa;            &#39;_TILDE_&#39;: &#39;~&#39;,&#xa;            &#39;_NUMBERSYMB_&#39;: &#39;№&#39;,&#xa;        }&#xa;&#xa;&#xa;        pattern = re.compile(&#39;|&#39;.join(re.escape(char) for char in revert_replacements.keys()))&#xa;&#xa;&#xa;        def replacer(match):&#xa;            return revert_replacements[match.group(0)]&#xa;&#xa;&#xa;        response_clean = response.json()[&#39;result&#39;][&#39;response&#39;][&#39;messages&#39;][-1]&#xa;        server_answer_content = response_clean[&#39;content&#39;]&#xa;        # inline_sources = response_clean[&#39;faq_sources&#39;]&#xa;        # for i in range(len(inline_sources)):&#xa;        #     replace_on_raw = inline_sources[i][&#39;metadata&#39;][&#39;tags&#39;][0]&#xa;        #     replace_on = pattern.sub(replacer, replace_on_raw)[1:]&#xa;        #     server_answer_content = server_answer_content.replace(f&#39;[^{i+1}^]&#39;, f&quot;[{replace_on}]&quot;)&#xa;&#xa;&#xa;        inline_sources = response.json()[&#39;result&#39;][&#39;response&#39;][&#39;messages&#39;][-1][&#39;inline_sources&#39;]&#xa;        for i, inl_src in enumerate(inline_sources):&#xa;            replace_on = &quot;&quot;&#xa;            if inl_src[&#39;source_type&#39;] == &#39;faq&#39;:&#xa;                replace_on_raw = inl_src[&#39;source&#39;][&#39;metadata&#39;][&#39;tags&#39;][0]&#xa;                replace_on = &#39;[&#39; + pattern.sub(replacer, replace_on_raw)[1:] + &#39;]&#39;&#xa;            elif inl_src[&#39;source_type&#39;] == &#39;passage&#39;:&#xa;                path_elements = inl_src[&#39;source&#39;][&#39;metadata&#39;][&#39;breadcrumbs&#39;].split(&#39;/&#39;)&#xa;                if len(path_elements) &gt; 1:&#xa;                    replace_on = &#39;[&#39; + path_elements[-2] + &#39;]&#39;&#xa;            server_answer_content = server_answer_content.replace(f&#39;[^{i+1}^]&#39;, f&quot;{replace_on}&quot;)&#xa;&#xa;&#xa;&#xa;&#xa;        log(f&quot;ПОЛУЧЕННЫЙ ОТВЕТ С IDP {server_answer_content}&quot;)&#xa;        user.variables.set(&#39;IDP_answer&#39;, server_answer_content)&#xa;        log(f&quot;Успешный запрос к {uri}. Ответ обработан.&quot;, level=&quot;INFO&quot;)&#xa;        log(f&quot;ПОЛУЧЕННЫЙ ОТВЕТ С IDP {server_answer_content}&quot;)&#xa;        user.variables.set(&#39;IDP_answer&#39;, server_answer_content)&#xa;        log(f&quot;Успешный запрос к {uri}. Ответ обработан.&quot;, level=&quot;INFO&quot;)&#xa;&#xa;&#xa;    except requests.RequestException as e:&#xa;        user.variables.set(&#39;IDP_answer&#39;, &#39;Ошибка при обработке запроса&#39;)&#xa;        log(f&quot;Ответ от IDP: {response.text}&quot;, level=&quot;INFO&quot;)&#xa;        log(f&quot;Ошибка запроса к {uri}: {str(e)}&quot;, level=&quot;ERROR&quot;)&#xa;    except (KeyError, IndexError, ValueError) as e:&#xa;        user.variables.set(&#39;IDP_answer&#39;, &#39;Ошибка при обработке ответа&#39;)&#xa;        log(f&quot;Ответ от IDP: {response.text}&quot;, level=&quot;INFO&quot;)&#xa;        log(f&quot;Ошибка обработки ответа: {str(e)}&quot;, level=&quot;ERROR&quot;)&#xa;&#xa;&#xa;if __name__ == &#39;__main__&#39;:&#xa;    questions = [&quot;Какие манипуляции с долгом возможны в отчетности?&quot;,&#xa;&quot;По какому участнику сделки требуется построение прогноза движения денежных средств при установлении ИР на Консолидированную Группу?&quot;,&#xa;&quot;На какой срок строятся будущие денежные потоки?&quot;,&#xa;&quot;Как определить, что деятельность носит сезонный характер?&quot;,&#xa;&quot;Можно ли строить будущие денежные потоки в иностранной валюте?&quot;,&#xa;&quot;Относится ли к прочим изменениям увеличение срока действующей банковской гарантии в пределах срока лимита ЕДБГ без увеличения срока действия лимита ЕДБГ?&quot;,&#xa;&quot;Требуется ли проверка Fraud-риска по техническим изменениям?&quot;,&#xa;&quot;Является ли прочим изменением продление периода выборки по сделке УФН?&quot;,&#xa;&quot;Финансирует ли Банк казино?&quot;,&#xa;&quot;Особенности финансирования по договорам простого товарищества&quot;,&#xa;&quot;Может ли банк финансировать некоммерческие организации?&quot;]&#xa;    for question in questions:&#xa;        run_request(question)&#xa;Это скрипт для отправки запроса в сервис.&#xa;Нужно сделать аналогичный, для отправки на такой API:&#xa;@router.post(&#xa;    &quot;/idp_search&quot;,&#xa;    status_code=status.HTTP_200_OK,&#xa;    response_model=schemas.IDPSearchResponse,&#xa;    responses={&#xa;        status.HTTP_424_FAILED_DEPENDENCY: {&#xa;            &quot;description&quot;: &quot;Ошибка при взаимодействии с IDP системой&quot;,&#xa;            &quot;model&quot;: schemas.IDPErrorResponse,&#xa;        },&#xa;    },&#xa;)&#xa;async def idp_search(&#xa;    request: schemas.IDPSearchRequest,&#xa;    headers: dict = Depends(common_headers),&#xa;):&#xa;    &quot;&quot;&quot;&#xa;    Поиск информации в IDP (Intelligent Data Platform).&#xa;    &#xa;    Этот endpoint позволяет выполнить поиск информации в корпоративной базе знаний &#xa;    через IDP API. Система автоматически обрабатывает запрос, выполняет поиск&#xa;    по документам и возвращает ответ с ссылками на источники.&#xa;    &quot;&quot;&quot;&#xa;    logger.info(f&quot;Processing IDP search request: &#39;{request.question[:100]}...&#39;&quot;)&#xa;    &#xa;    # Отправляем запрос через IDP сервис&#xa;    answer, response_time, error_msg, external_uuid = await idp_service.search(request.question)&#xa;    &#xa;    if error_msg:&#xa;        logger.error(f&quot;IDP search failed: {error_msg}&quot;)&#xa;        return JSONResponse(&#xa;            status_code=status.HTTP_424_FAILED_DEPENDENCY,&#xa;            content=schemas.IDPErrorResponse(&#xa;                error_description=f&quot;Ошибка при обращении к IDP: {error_msg}&quot;,&#xa;                error_code=error_msg,&#xa;                response_time=response_time,&#xa;            ).model_dump(),&#xa;        )&#xa;    &#xa;    logger.info(f&quot;IDP search completed in {response_time:.2f}s&quot;)&#xa;    return schemas.IDPSearchResponse(&#xa;        answer=answer,&#xa;        response_time=response_time,&#xa;        external_uuid=external_uuid,&#xa;    )&#xa;&#xa;&#xa;# IDP Schemas&#xa;&#xa;&#xa;class IDPSearchRequest(BaseModel):&#xa;    &quot;&quot;&quot;Тело запроса для IDP поиска&quot;&quot;&quot;&#xa;&#xa;&#xa;    question: str = Field(&#xa;        description=&quot;Вопрос для поиска в IDP (Intelligent Data Platform)&quot;,&#xa;        min_length=4,&#xa;        examples=[&#xa;            &quot;Какие манипуляции с долгом возможны в отчетности?&quot;,&#xa;            &quot;По какому участнику сделки требуется построение прогноза движения денежных средств?&quot;,&#xa;            &quot;На какой срок строятся будущие денежные потоки?&quot;&#xa;        ],&#xa;    )&#xa;&#xa;&#xa;&#xa;&#xa;class IDPSearchResponse(BaseModel):&#xa;    &quot;&quot;&quot;Ответ для IDP поиска&quot;&quot;&quot;&#xa;&#xa;&#xa;    answer: str = Field(&#xa;        description=&quot;Ответ от IDP с информацией из базы знаний и ссылками на источники&quot;,&#xa;        examples=[&#xa;            &quot;Согласно документации [Руководство по кредитным операциям], манипуляции с долгом включают реструктуризацию, рефинансирование и списание безнадежной задолженности.&quot;&#xa;        ],&#xa;    )&#xa;    response_time: float = Field(&#xa;        description=&quot;Время ответа в секундах&quot;,&#xa;        examples=[3.24],&#xa;    )&#xa;    external_uuid: str = Field(&#xa;        description=&quot;Уникальный идентификатор запроса&quot;,&#xa;        examples=[&quot;550e8400-e29b-41d4-a716-446655440000&quot;],&#xa;    )&#xa;&#xa;&#xa;&#xa;&#xa;class IDPErrorResponse(BaseModel):&#xa;    &quot;&quot;&quot;Ошибка при работе с IDP&quot;&quot;&quot;&#xa;&#xa;&#xa;    error_description: str = Field(&#xa;        description=&quot;Описание ошибки при обращении к IDP&quot;,&#xa;        examples=[&#xa;            &quot;Ошибка при обработке запроса к IDP&quot;,&#xa;            &quot;Timeout при обращении к IDP API&quot;,&#xa;            &quot;Ошибка при обработке ответа от IDP&quot;&#xa;        ],&#xa;    )&#xa;    error_code: str = Field(&#xa;        description=&quot;Код ошибки&quot;,&#xa;        examples=[&quot;IDP_REQUEST_ERROR&quot;, &quot;IDP_TIMEOUT_ERROR&quot;, &quot;IDP_RESPONSE_ERROR&quot;],&#xa;    )&#xa;    response_time: Optional[float] = Field(&#xa;        description=&quot;Время ответа в секундах (если доступно)&quot;,&#xa;        examples=[5.0],&#xa;        default=None,&#xa;    )" id="tjXOWgZFEl35QNcsJMh5-1">
          <mxCell style="text;whiteSpace=wrap;" parent="1" vertex="1">
            <mxGeometry x="1030" y="330" width="560" height="5090" as="geometry" />
          </mxCell>
        </UserObject>
        <UserObject label="# idp_client.py&#xa;import os&#xa;import uuid&#xa;import time&#xa;import json&#xa;import requests&#xa;from typing import Optional, Tuple, Dict, Any, List&#xa;from requests.adapters import HTTPAdapter, Retry&#xa;&#xa;&#xa;from core.logging.logger_utils import log&#xa;from scenarios.user.user_model import User&#xa;&#xa;&#xa;&#xa;&#xa;# -----------------------------&#xa;# ВСПОМОГАТЕЛЬНЫЕ НАСТРОЙКИ&#xa;# -----------------------------&#xa;DEFAULT_API_BASE = os.getenv(&quot;IDP_GATEWAY_BASE&quot;, &quot;http://localhost:8000&quot;)  # где крутится твой FastAPI&#xa;ENDPOINT_PATH = os.getenv(&quot;IDP_SEARCH_PATH&quot;, &quot;/idp_search&quot;)&#xa;&#xa;&#xa;# Если ваш Depends(common_headers) ожидает определённые заголовки — добавь их в ENV и сюда&#xa;DEFAULT_HEADERS: Dict[str, str] = {&#xa;    &quot;accept&quot;: &quot;application/json&quot;,&#xa;    &quot;Content-Type&quot;: &quot;application/json&quot;,&#xa;    # Примеры корпоративных заголовков — подставь нужные, если требуется:&#xa;    # &quot;X-Request-Source&quot;: os.getenv(&quot;X_REQUEST_SOURCE&quot;, &quot;your-service&quot;),&#xa;    # &quot;X-Auth-Token&quot;: os.getenv(&quot;X_AUTH_TOKEN&quot;, &quot;&quot;),&#xa;}&#xa;&#xa;&#xa;REQUEST_TIMEOUT = float(os.getenv(&quot;IDP_CLIENT_TIMEOUT&quot;, &quot;30&quot;))  # сек.&#xa;RETRY_TOTAL = int(os.getenv(&quot;IDP_CLIENT_RETRY_TOTAL&quot;, &quot;3&quot;))&#xa;RETRY_BACKOFF = float(os.getenv(&quot;IDP_CLIENT_RETRY_BACKOFF&quot;, &quot;0.5&quot;))  # экспоненциальная пауза&#xa;&#xa;&#xa;&#xa;&#xa;def _build_session() -&gt; requests.Session:&#xa;    &quot;&quot;&quot;&#xa;    Готовим requests.Session с умным ретраем (на случай сетевых глюков, 502/503/504).&#xa;    &quot;&quot;&quot;&#xa;    session = requests.Session()&#xa;    retries = Retry(&#xa;        total=RETRY_TOTAL,&#xa;        backoff_factor=RETRY_BACKOFF,&#xa;        status_forcelist=(502, 503, 504),&#xa;        allowed_methods=frozenset([&quot;POST&quot;]),&#xa;        raise_on_status=False,&#xa;    )&#xa;    adapter = HTTPAdapter(max_retries=retries)&#xa;    session.mount(&quot;http://&quot;, adapter)&#xa;    session.mount(&quot;https://&quot;, adapter)&#xa;    return session&#xa;&#xa;&#xa;&#xa;&#xa;def _safe_get(dct: Dict[str, Any], path: List[str], default=None):&#xa;    &quot;&quot;&quot;&#xa;    Безопасно достаём значение из вложенного словаря по пути ключей.&#xa;    &quot;&quot;&quot;&#xa;    cur = dct&#xa;    for key in path:&#xa;        if not isinstance(cur, dict) or key not in cur:&#xa;            return default&#xa;        cur = cur[key]&#xa;    return cur&#xa;&#xa;&#xa;&#xa;&#xa;def _normalize_answer_text(text: str) -&gt; str:&#xa;    &quot;&quot;&quot;&#xa;    Хук на будущее: если когда-либо вернутся inline-ссылки вида [^1^],&#xa;    здесь можно будет подменять их на понятные ярлыки.&#xa;    Сейчас просто возвращаем как есть.&#xa;    &quot;&quot;&quot;&#xa;    return text&#xa;&#xa;&#xa;&#xa;&#xa;def _compose_url(base: str, path: str) -&gt; str:&#xa;    base = base.rstrip(&quot;/&quot;)&#xa;    path = path if path.startswith(&quot;/&quot;) else f&quot;/{path}&quot;&#xa;    return f&quot;{base}{path}&quot;&#xa;&#xa;&#xa;&#xa;&#xa;def run_idp_search(user: User, api_base: Optional[str] = None) -&gt; None:&#xa;    &quot;&quot;&quot;&#xa;    Отправляет вопрос на FastAPI эндпоинт /idp_search и записывает результат в user.variables.&#xa;&#xa;&#xa;    Вход:&#xa;        - user.variables[&#39;IDP_question&#39;] : строка вопроса.&#xa;    Выход:&#xa;        - user.variables[&#39;IDP_answer&#39;]         : текст ответа или текст ошибки.&#xa;        - user.variables[&#39;IDP_external_uuid&#39;]  : uuid запроса (если вернулся).&#xa;        - user.variables[&#39;IDP_response_time&#39;]  : время ответа в секундах (если вернулось).&#xa;&#xa;&#xa;    Исключения не пробрасываем — всё логируем и безопасно сохраняем в user.variables.&#xa;    &quot;&quot;&quot;&#xa;    question = user.variables.get(&quot;IDP_question&quot;, &quot;&quot;)&#xa;    if not isinstance(question, str) or len(question.strip()) &lt; 4:&#xa;        msg = &quot;Вопрос пустой или короче 4 символов — IDP его отклонит согласно модели схем.&quot;&#xa;        log(msg, level=&quot;ERROR&quot;)&#xa;        user.variables.set(&quot;IDP_answer&quot;, msg)&#xa;        return&#xa;&#xa;&#xa;    base = api_base or DEFAULT_API_BASE&#xa;    url = _compose_url(base, ENDPOINT_PATH)&#xa;&#xa;&#xa;    # Можно прокинуть trace-id в заголовки для сквозной трассировки&#xa;    external_uuid = str(uuid.uuid4())&#xa;&#xa;&#xa;    headers = dict(DEFAULT_HEADERS)&#xa;    headers[&quot;X-External-UUID&quot;] = external_uuid  # опционально — если на бэке это используется&#xa;&#xa;&#xa;    payload = {&quot;question&quot;: question}&#xa;&#xa;&#xa;    log(f&quot;IDP_SEARCH ▶ POST {url} | headers={headers} | payload={payload}&quot;)&#xa;&#xa;&#xa;    session = _build_session()&#xa;    t0 = time.perf_counter()&#xa;&#xa;&#xa;    try:&#xa;        resp = session.post(url, headers=headers, data=json.dumps(payload), timeout=REQUEST_TIMEOUT)&#xa;        elapsed = time.perf_counter() - t0&#xa;&#xa;&#xa;        # 200 OK — успешный ответ&#xa;        if resp.status_code == 200:&#xa;            data = resp.json()&#xa;&#xa;&#xa;            answer = _safe_get(data, [&quot;answer&quot;], &quot;&quot;)&#xa;            response_time = _safe_get(data, [&quot;response_time&quot;], elapsed)&#xa;            returned_uuid = _safe_get(data, [&quot;external_uuid&quot;], external_uuid)&#xa;&#xa;&#xa;            normalized_answer = _normalize_answer_text(answer)&#xa;&#xa;&#xa;            log(&#xa;                f&quot;IDP_SEARCH ✔ 200 | time={response_time:.2f}s | uuid={returned_uuid} | &quot;&#xa;                f&quot;answer_preview=&#39;{(normalized_answer or &#39;&#39;)[:180]}...&#39;&quot;,&#xa;                level=&quot;INFO&quot;,&#xa;            )&#xa;&#xa;&#xa;            user.variables.set(&quot;IDP_answer&quot;, normalized_answer or &quot;&quot;)&#xa;            user.variables.set(&quot;IDP_external_uuid&quot;, returned_uuid)&#xa;            user.variables.set(&quot;IDP_response_time&quot;, response_time)&#xa;            return&#xa;&#xa;&#xa;        # 424 — проксируем описание ошибки из тела по вашей схеме IDPErrorResponse&#xa;        if resp.status_code == 424:&#xa;            try:&#xa;                err = resp.json()&#xa;            except Exception:&#xa;                err = {}&#xa;&#xa;&#xa;            err_desc = _safe_get(err, [&quot;error_description&quot;], &quot;Ошибка при обращении к IDP&quot;)&#xa;            err_code = _safe_get(err, [&quot;error_code&quot;], &quot;IDP_REQUEST_ERROR&quot;)&#xa;            response_time = _safe_get(err, [&quot;response_time&quot;], time.perf_counter() - t0)&#xa;&#xa;&#xa;            log(f&quot;IDP_SEARCH ✖ 424 | {err_code}: {err_desc} | time={response_time:.2f}s&quot;, level=&quot;ERROR&quot;)&#xa;&#xa;&#xa;            user.variables.set(&quot;IDP_answer&quot;, f&quot;{err_desc} (код: {err_code})&quot;)&#xa;            user.variables.set(&quot;IDP_external_uuid&quot;, external_uuid)&#xa;            user.variables.set(&quot;IDP_response_time&quot;, response_time)&#xa;            return&#xa;&#xa;&#xa;        # Прочие статусы — максимально информативный лог + тело&#xa;        body_preview = &quot;&quot;&#xa;        try:&#xa;            body_preview = json.dumps(resp.json(), ensure_ascii=False)[:500]&#xa;        except Exception:&#xa;            body_preview = (resp.text or &quot;&quot;)[:500]&#xa;&#xa;&#xa;        log(&#xa;            f&quot;IDP_SEARCH ✖ {resp.status_code} {resp.reason} | body=&#39;{body_preview}&#39;&quot;,&#xa;            level=&quot;ERROR&quot;,&#xa;        )&#xa;&#xa;&#xa;        user.variables.set(&#xa;            &quot;IDP_answer&quot;,&#xa;            f&quot;Ошибка: {resp.status_code} {resp.reason}. Обратитесь к логам сервиса.&quot;,&#xa;        )&#xa;        user.variables.set(&quot;IDP_external_uuid&quot;, external_uuid)&#xa;        user.variables.set(&quot;IDP_response_time&quot;, time.perf_counter() - t0)&#xa;&#xa;&#xa;    except requests.Timeout as e:&#xa;        elapsed = time.perf_counter() - t0&#xa;        log(f&quot;IDP_SEARCH ⏱ timeout after {elapsed:.2f}s: {str(e)}&quot;, level=&quot;ERROR&quot;)&#xa;        user.variables.set(&quot;IDP_answer&quot;, &quot;Timeout при обращении к /idp_search&quot;)&#xa;        user.variables.set(&quot;IDP_external_uuid&quot;, external_uuid)&#xa;        user.variables.set(&quot;IDP_response_time&quot;, elapsed)&#xa;&#xa;&#xa;    except requests.RequestException as e:&#xa;        elapsed = time.perf_counter() - t0&#xa;        log(f&quot;IDP_SEARCH ⚠ network error: {str(e)}&quot;, level=&quot;ERROR&quot;)&#xa;        user.variables.set(&quot;IDP_answer&quot;, &quot;Сетевая ошибка при обращении к /idp_search&quot;)&#xa;        user.variables.set(&quot;IDP_external_uuid&quot;, external_uuid)&#xa;        user.variables.set(&quot;IDP_response_time&quot;, elapsed)&#xa;&#xa;&#xa;    except Exception as e:&#xa;        elapsed = time.perf_counter() - t0&#xa;        log(f&quot;IDP_SEARCH ☠ unexpected error: {str(e)}&quot;, level=&quot;ERROR&quot;)&#xa;        user.variables.set(&quot;IDP_answer&quot;, &quot;Неожиданная ошибка клиента IDP&quot;)&#xa;        user.variables.set(&quot;IDP_external_uuid&quot;, external_uuid)&#xa;        user.variables.set(&quot;IDP_response_time&quot;, elapsed)&#xa;&#xa;&#xa;&#xa;&#xa;# --------------------------------------&#xa;# НЕОБЯЗАТЕЛЬНО: асинхронная версия (httpx)&#xa;# --------------------------------------&#xa;# Используй, если у тебя асинхронный воркер, и хочется не блокировать луп.&#xa;# Поведение и контракты идентичны синхронной версии.&#xa;async def run_idp_search_async(user: User, api_base: Optional[str] = None) -&gt; None:&#xa;    import httpx&#xa;    import asyncio&#xa;&#xa;&#xa;    question = user.variables.get(&quot;IDP_question&quot;, &quot;&quot;)&#xa;    if not isinstance(question, str) or len(question.strip()) &lt; 4:&#xa;        msg = &quot;Вопрос пустой или короче 4 символов — IDP его отклонит согласно модели схем.&quot;&#xa;        log(msg, level=&quot;ERROR&quot;)&#xa;        user.variables.set(&quot;IDP_answer&quot;, msg)&#xa;        return&#xa;&#xa;&#xa;    base = api_base or DEFAULT_API_BASE&#xa;    url = _compose_url(base, ENDPOINT_PATH)&#xa;&#xa;&#xa;    external_uuid = str(uuid.uuid4())&#xa;    headers = dict(DEFAULT_HEADERS)&#xa;    headers[&quot;X-External-UUID&quot;] = external_uuid&#xa;&#xa;&#xa;    payload = {&quot;question&quot;: question}&#xa;    log(f&quot;IDP_SEARCH(async) ▶ POST {url} | headers={headers} | payload={payload}&quot;)&#xa;&#xa;&#xa;    # Ретраи вручную, т.к. httpx не имеет встроенного Retry, как requests+urllib3&#xa;    attempts = RETRY_TOTAL + 1&#xa;    backoff = RETRY_BACKOFF&#xa;&#xa;&#xa;    t0 = time.perf_counter()&#xa;&#xa;&#xa;    async with httpx.AsyncClient(timeout=REQUEST_TIMEOUT) as client:&#xa;        for attempt in range(1, attempts + 1):&#xa;            try:&#xa;                resp = await client.post(url, headers=headers, json=payload)&#xa;                elapsed = time.perf_counter() - t0&#xa;&#xa;&#xa;                if resp.status_code == 200:&#xa;                    data = resp.json()&#xa;                    answer = data.get(&quot;answer&quot;, &quot;&quot;)&#xa;                    response_time = data.get(&quot;response_time&quot;, elapsed)&#xa;                    returned_uuid = data.get(&quot;external_uuid&quot;, external_uuid)&#xa;&#xa;&#xa;                    normalized_answer = _normalize_answer_text(answer)&#xa;                    log(&#xa;                        f&quot;IDP_SEARCH(async) ✔ 200 | time={response_time:.2f}s | uuid={returned_uuid} | &quot;&#xa;                        f&quot;answer_preview=&#39;{(normalized_answer or &#39;&#39;)[:180]}...&#39;&quot;,&#xa;                        level=&quot;INFO&quot;,&#xa;                    )&#xa;                    user.variables.set(&quot;IDP_answer&quot;, normalized_answer or &quot;&quot;)&#xa;                    user.variables.set(&quot;IDP_external_uuid&quot;, returned_uuid)&#xa;                    user.variables.set(&quot;IDP_response_time&quot;, response_time)&#xa;                    return&#xa;&#xa;&#xa;                if resp.status_code == 424:&#xa;                    err = resp.json()&#xa;                    err_desc = err.get(&quot;error_description&quot;, &quot;Ошибка при обращении к IDP&quot;)&#xa;                    err_code = err.get(&quot;error_code&quot;, &quot;IDP_REQUEST_ERROR&quot;)&#xa;                    response_time = err.get(&quot;response_time&quot;, elapsed)&#xa;&#xa;&#xa;                    log(f&quot;IDP_SEARCH(async) ✖ 424 | {err_code}: {err_desc} | time={response_time:.2f}s&quot;, level=&quot;ERROR&quot;)&#xa;                    user.variables.set(&quot;IDP_answer&quot;, f&quot;{err_desc} (код: {err_code})&quot;)&#xa;                    user.variables.set(&quot;IDP_external_uuid&quot;, external_uuid)&#xa;                    user.variables.set(&quot;IDP_response_time&quot;, response_time)&#xa;                    return&#xa;&#xa;&#xa;                # На 502/503/504 поделаем ретраи&#xa;                if resp.status_code in (502, 503, 504) and attempt &lt; attempts:&#xa;                    log(f&quot;IDP_SEARCH(async) ↻ retry {attempt}/{attempts-1} after {backoff:.1f}s (status {resp.status_code})&quot;)&#xa;                    await asyncio.sleep(backoff)&#xa;                    backoff *= 2&#xa;                    continue&#xa;&#xa;&#xa;                # Иначе — ошибка без ретрая&#xa;                body_preview = &quot;&quot;&#xa;                try:&#xa;                    body_preview = json.dumps(resp.json(), ensure_ascii=False)[:500]&#xa;                except Exception:&#xa;                    body_preview = (resp.text or &quot;&quot;)[:500]&#xa;&#xa;&#xa;                log(&#xa;                    f&quot;IDP_SEARCH(async) ✖ {resp.status_code} {resp.reason_phrase} | body=&#39;{body_preview}&#39;&quot;,&#xa;                    level=&quot;ERROR&quot;,&#xa;                )&#xa;                user.variables.set(&#xa;                    &quot;IDP_answer&quot;,&#xa;                    f&quot;Ошибка: {resp.status_code} {resp.reason_phrase}. Обратитесь к логам сервиса.&quot;,&#xa;                )&#xa;                user.variables.set(&quot;IDP_external_uuid&quot;, external_uuid)&#xa;                user.variables.set(&quot;IDP_response_time&quot;, elapsed)&#xa;                return&#xa;&#xa;&#xa;            except (httpx.TimeoutException, httpx.TransportError) as e:&#xa;                if attempt &lt; attempts:&#xa;                    log(f&quot;IDP_SEARCH(async) ↻ retry {attempt}/{attempts-1} after {backoff:.1f}s due to network error: {e}&quot;)&#xa;                    await asyncio.sleep(backoff)&#xa;                    backoff *= 2&#xa;                    continue&#xa;&#xa;&#xa;                elapsed = time.perf_counter() - t0&#xa;                log(f&quot;IDP_SEARCH(async) ⚠ network/timeout error: {str(e)}&quot;, level=&quot;ERROR&quot;)&#xa;                user.variables.set(&quot;IDP_answer&quot;, &quot;Сетевая ошибка при обращении к /idp_search&quot;)&#xa;                user.variables.set(&quot;IDP_external_uuid&quot;, external_uuid)&#xa;                user.variables.set(&quot;IDP_response_time&quot;, elapsed)&#xa;                return&#xa;&#xa;&#xa;&#xa;&#xa;if __name__ == &quot;__main__&quot;:&#xa;    # Пример запуска как у тебя, но через новый клиент&#xa;    questions = [&#xa;        &quot;Какие манипуляции с долгом возможны в отчетности?&quot;,&#xa;        &quot;По какому участнику сделки требуется построение прогноза движения денежных средств при установлении ИР на Консолидированную Группу?&quot;,&#xa;        &quot;На какой срок строятся будущие денежные потоки?&quot;,&#xa;        &quot;Как определить, что деятельность носит сезонный характер?&quot;,&#xa;        &quot;Можно ли строить будущие денежные потоки в иностранной валюте?&quot;,&#xa;        &quot;Относится ли к прочим изменениям увеличение срока действующей банковской гарантии?&quot;,&#xa;        &quot;Требуется ли проверка Fraud-риска по техническим изменениям?&quot;,&#xa;        &quot;Является ли прочим изменением продление периода выборки по сделке УФН?&quot;,&#xa;        &quot;Финансирует ли Банк казино?&quot;,&#xa;        &quot;Особенности финансирования по договорам простого товарищества&quot;,&#xa;        &quot;Может ли банк финансировать некоммерческие организации?&quot;,&#xa;    ]&#xa;&#xa;&#xa;    # Импорт твоей модели User остаётся прежним.&#xa;    # Ниже — простая заглушка. В реальном коде у тебя уже есть инстанс user.&#xa;    class _VarStore(dict):&#xa;        def set(self, k, v):&#xa;            self[k] = v&#xa;&#xa;&#xa;    class _User:&#xa;        def __init__(self):&#xa;            self.variables = _VarStore()&#xa;&#xa;&#xa;    for q in questions:&#xa;        u = _User()&#xa;        u.variables.set(&quot;IDP_question&quot;, q)&#xa;        run_idp_search(u)&#xa;        print(f&quot;Q: {q}\nA: {u.variables.get(&#39;IDP_answer&#39;)}\nUUID: {u.variables.get(&#39;IDP_external_uuid&#39;)}, &quot;&#xa;              f&quot;Time: {u.variables.get(&#39;IDP_response_time&#39;)}s\n{&#39;-&#39;*80}&quot;)" link="# idp_client.py&#xa;import os&#xa;import uuid&#xa;import time&#xa;import json&#xa;import requests&#xa;from typing import Optional, Tuple, Dict, Any, List&#xa;from requests.adapters import HTTPAdapter, Retry&#xa;&#xa;&#xa;from core.logging.logger_utils import log&#xa;from scenarios.user.user_model import User&#xa;&#xa;&#xa;&#xa;&#xa;# -----------------------------&#xa;# ВСПОМОГАТЕЛЬНЫЕ НАСТРОЙКИ&#xa;# -----------------------------&#xa;DEFAULT_API_BASE = os.getenv(&quot;IDP_GATEWAY_BASE&quot;, &quot;http://localhost:8000&quot;)  # где крутится твой FastAPI&#xa;ENDPOINT_PATH = os.getenv(&quot;IDP_SEARCH_PATH&quot;, &quot;/idp_search&quot;)&#xa;&#xa;&#xa;# Если ваш Depends(common_headers) ожидает определённые заголовки — добавь их в ENV и сюда&#xa;DEFAULT_HEADERS: Dict[str, str] = {&#xa;    &quot;accept&quot;: &quot;application/json&quot;,&#xa;    &quot;Content-Type&quot;: &quot;application/json&quot;,&#xa;    # Примеры корпоративных заголовков — подставь нужные, если требуется:&#xa;    # &quot;X-Request-Source&quot;: os.getenv(&quot;X_REQUEST_SOURCE&quot;, &quot;your-service&quot;),&#xa;    # &quot;X-Auth-Token&quot;: os.getenv(&quot;X_AUTH_TOKEN&quot;, &quot;&quot;),&#xa;}&#xa;&#xa;&#xa;REQUEST_TIMEOUT = float(os.getenv(&quot;IDP_CLIENT_TIMEOUT&quot;, &quot;30&quot;))  # сек.&#xa;RETRY_TOTAL = int(os.getenv(&quot;IDP_CLIENT_RETRY_TOTAL&quot;, &quot;3&quot;))&#xa;RETRY_BACKOFF = float(os.getenv(&quot;IDP_CLIENT_RETRY_BACKOFF&quot;, &quot;0.5&quot;))  # экспоненциальная пауза&#xa;&#xa;&#xa;&#xa;&#xa;def _build_session() -&gt; requests.Session:&#xa;    &quot;&quot;&quot;&#xa;    Готовим requests.Session с умным ретраем (на случай сетевых глюков, 502/503/504).&#xa;    &quot;&quot;&quot;&#xa;    session = requests.Session()&#xa;    retries = Retry(&#xa;        total=RETRY_TOTAL,&#xa;        backoff_factor=RETRY_BACKOFF,&#xa;        status_forcelist=(502, 503, 504),&#xa;        allowed_methods=frozenset([&quot;POST&quot;]),&#xa;        raise_on_status=False,&#xa;    )&#xa;    adapter = HTTPAdapter(max_retries=retries)&#xa;    session.mount(&quot;http://&quot;, adapter)&#xa;    session.mount(&quot;https://&quot;, adapter)&#xa;    return session&#xa;&#xa;&#xa;&#xa;&#xa;def _safe_get(dct: Dict[str, Any], path: List[str], default=None):&#xa;    &quot;&quot;&quot;&#xa;    Безопасно достаём значение из вложенного словаря по пути ключей.&#xa;    &quot;&quot;&quot;&#xa;    cur = dct&#xa;    for key in path:&#xa;        if not isinstance(cur, dict) or key not in cur:&#xa;            return default&#xa;        cur = cur[key]&#xa;    return cur&#xa;&#xa;&#xa;&#xa;&#xa;def _normalize_answer_text(text: str) -&gt; str:&#xa;    &quot;&quot;&quot;&#xa;    Хук на будущее: если когда-либо вернутся inline-ссылки вида [^1^],&#xa;    здесь можно будет подменять их на понятные ярлыки.&#xa;    Сейчас просто возвращаем как есть.&#xa;    &quot;&quot;&quot;&#xa;    return text&#xa;&#xa;&#xa;&#xa;&#xa;def _compose_url(base: str, path: str) -&gt; str:&#xa;    base = base.rstrip(&quot;/&quot;)&#xa;    path = path if path.startswith(&quot;/&quot;) else f&quot;/{path}&quot;&#xa;    return f&quot;{base}{path}&quot;&#xa;&#xa;&#xa;&#xa;&#xa;def run_idp_search(user: User, api_base: Optional[str] = None) -&gt; None:&#xa;    &quot;&quot;&quot;&#xa;    Отправляет вопрос на FastAPI эндпоинт /idp_search и записывает результат в user.variables.&#xa;&#xa;&#xa;    Вход:&#xa;        - user.variables[&#39;IDP_question&#39;] : строка вопроса.&#xa;    Выход:&#xa;        - user.variables[&#39;IDP_answer&#39;]         : текст ответа или текст ошибки.&#xa;        - user.variables[&#39;IDP_external_uuid&#39;]  : uuid запроса (если вернулся).&#xa;        - user.variables[&#39;IDP_response_time&#39;]  : время ответа в секундах (если вернулось).&#xa;&#xa;&#xa;    Исключения не пробрасываем — всё логируем и безопасно сохраняем в user.variables.&#xa;    &quot;&quot;&quot;&#xa;    question = user.variables.get(&quot;IDP_question&quot;, &quot;&quot;)&#xa;    if not isinstance(question, str) or len(question.strip()) &lt; 4:&#xa;        msg = &quot;Вопрос пустой или короче 4 символов — IDP его отклонит согласно модели схем.&quot;&#xa;        log(msg, level=&quot;ERROR&quot;)&#xa;        user.variables.set(&quot;IDP_answer&quot;, msg)&#xa;        return&#xa;&#xa;&#xa;    base = api_base or DEFAULT_API_BASE&#xa;    url = _compose_url(base, ENDPOINT_PATH)&#xa;&#xa;&#xa;    # Можно прокинуть trace-id в заголовки для сквозной трассировки&#xa;    external_uuid = str(uuid.uuid4())&#xa;&#xa;&#xa;    headers = dict(DEFAULT_HEADERS)&#xa;    headers[&quot;X-External-UUID&quot;] = external_uuid  # опционально — если на бэке это используется&#xa;&#xa;&#xa;    payload = {&quot;question&quot;: question}&#xa;&#xa;&#xa;    log(f&quot;IDP_SEARCH ▶ POST {url} | headers={headers} | payload={payload}&quot;)&#xa;&#xa;&#xa;    session = _build_session()&#xa;    t0 = time.perf_counter()&#xa;&#xa;&#xa;    try:&#xa;        resp = session.post(url, headers=headers, data=json.dumps(payload), timeout=REQUEST_TIMEOUT)&#xa;        elapsed = time.perf_counter() - t0&#xa;&#xa;&#xa;        # 200 OK — успешный ответ&#xa;        if resp.status_code == 200:&#xa;            data = resp.json()&#xa;&#xa;&#xa;            answer = _safe_get(data, [&quot;answer&quot;], &quot;&quot;)&#xa;            response_time = _safe_get(data, [&quot;response_time&quot;], elapsed)&#xa;            returned_uuid = _safe_get(data, [&quot;external_uuid&quot;], external_uuid)&#xa;&#xa;&#xa;            normalized_answer = _normalize_answer_text(answer)&#xa;&#xa;&#xa;            log(&#xa;                f&quot;IDP_SEARCH ✔ 200 | time={response_time:.2f}s | uuid={returned_uuid} | &quot;&#xa;                f&quot;answer_preview=&#39;{(normalized_answer or &#39;&#39;)[:180]}...&#39;&quot;,&#xa;                level=&quot;INFO&quot;,&#xa;            )&#xa;&#xa;&#xa;            user.variables.set(&quot;IDP_answer&quot;, normalized_answer or &quot;&quot;)&#xa;            user.variables.set(&quot;IDP_external_uuid&quot;, returned_uuid)&#xa;            user.variables.set(&quot;IDP_response_time&quot;, response_time)&#xa;            return&#xa;&#xa;&#xa;        # 424 — проксируем описание ошибки из тела по вашей схеме IDPErrorResponse&#xa;        if resp.status_code == 424:&#xa;            try:&#xa;                err = resp.json()&#xa;            except Exception:&#xa;                err = {}&#xa;&#xa;&#xa;            err_desc = _safe_get(err, [&quot;error_description&quot;], &quot;Ошибка при обращении к IDP&quot;)&#xa;            err_code = _safe_get(err, [&quot;error_code&quot;], &quot;IDP_REQUEST_ERROR&quot;)&#xa;            response_time = _safe_get(err, [&quot;response_time&quot;], time.perf_counter() - t0)&#xa;&#xa;&#xa;            log(f&quot;IDP_SEARCH ✖ 424 | {err_code}: {err_desc} | time={response_time:.2f}s&quot;, level=&quot;ERROR&quot;)&#xa;&#xa;&#xa;            user.variables.set(&quot;IDP_answer&quot;, f&quot;{err_desc} (код: {err_code})&quot;)&#xa;            user.variables.set(&quot;IDP_external_uuid&quot;, external_uuid)&#xa;            user.variables.set(&quot;IDP_response_time&quot;, response_time)&#xa;            return&#xa;&#xa;&#xa;        # Прочие статусы — максимально информативный лог + тело&#xa;        body_preview = &quot;&quot;&#xa;        try:&#xa;            body_preview = json.dumps(resp.json(), ensure_ascii=False)[:500]&#xa;        except Exception:&#xa;            body_preview = (resp.text or &quot;&quot;)[:500]&#xa;&#xa;&#xa;        log(&#xa;            f&quot;IDP_SEARCH ✖ {resp.status_code} {resp.reason} | body=&#39;{body_preview}&#39;&quot;,&#xa;            level=&quot;ERROR&quot;,&#xa;        )&#xa;&#xa;&#xa;        user.variables.set(&#xa;            &quot;IDP_answer&quot;,&#xa;            f&quot;Ошибка: {resp.status_code} {resp.reason}. Обратитесь к логам сервиса.&quot;,&#xa;        )&#xa;        user.variables.set(&quot;IDP_external_uuid&quot;, external_uuid)&#xa;        user.variables.set(&quot;IDP_response_time&quot;, time.perf_counter() - t0)&#xa;&#xa;&#xa;    except requests.Timeout as e:&#xa;        elapsed = time.perf_counter() - t0&#xa;        log(f&quot;IDP_SEARCH ⏱ timeout after {elapsed:.2f}s: {str(e)}&quot;, level=&quot;ERROR&quot;)&#xa;        user.variables.set(&quot;IDP_answer&quot;, &quot;Timeout при обращении к /idp_search&quot;)&#xa;        user.variables.set(&quot;IDP_external_uuid&quot;, external_uuid)&#xa;        user.variables.set(&quot;IDP_response_time&quot;, elapsed)&#xa;&#xa;&#xa;    except requests.RequestException as e:&#xa;        elapsed = time.perf_counter() - t0&#xa;        log(f&quot;IDP_SEARCH ⚠ network error: {str(e)}&quot;, level=&quot;ERROR&quot;)&#xa;        user.variables.set(&quot;IDP_answer&quot;, &quot;Сетевая ошибка при обращении к /idp_search&quot;)&#xa;        user.variables.set(&quot;IDP_external_uuid&quot;, external_uuid)&#xa;        user.variables.set(&quot;IDP_response_time&quot;, elapsed)&#xa;&#xa;&#xa;    except Exception as e:&#xa;        elapsed = time.perf_counter() - t0&#xa;        log(f&quot;IDP_SEARCH ☠ unexpected error: {str(e)}&quot;, level=&quot;ERROR&quot;)&#xa;        user.variables.set(&quot;IDP_answer&quot;, &quot;Неожиданная ошибка клиента IDP&quot;)&#xa;        user.variables.set(&quot;IDP_external_uuid&quot;, external_uuid)&#xa;        user.variables.set(&quot;IDP_response_time&quot;, elapsed)&#xa;&#xa;&#xa;&#xa;&#xa;# --------------------------------------&#xa;# НЕОБЯЗАТЕЛЬНО: асинхронная версия (httpx)&#xa;# --------------------------------------&#xa;# Используй, если у тебя асинхронный воркер, и хочется не блокировать луп.&#xa;# Поведение и контракты идентичны синхронной версии.&#xa;async def run_idp_search_async(user: User, api_base: Optional[str] = None) -&gt; None:&#xa;    import httpx&#xa;    import asyncio&#xa;&#xa;&#xa;    question = user.variables.get(&quot;IDP_question&quot;, &quot;&quot;)&#xa;    if not isinstance(question, str) or len(question.strip()) &lt; 4:&#xa;        msg = &quot;Вопрос пустой или короче 4 символов — IDP его отклонит согласно модели схем.&quot;&#xa;        log(msg, level=&quot;ERROR&quot;)&#xa;        user.variables.set(&quot;IDP_answer&quot;, msg)&#xa;        return&#xa;&#xa;&#xa;    base = api_base or DEFAULT_API_BASE&#xa;    url = _compose_url(base, ENDPOINT_PATH)&#xa;&#xa;&#xa;    external_uuid = str(uuid.uuid4())&#xa;    headers = dict(DEFAULT_HEADERS)&#xa;    headers[&quot;X-External-UUID&quot;] = external_uuid&#xa;&#xa;&#xa;    payload = {&quot;question&quot;: question}&#xa;    log(f&quot;IDP_SEARCH(async) ▶ POST {url} | headers={headers} | payload={payload}&quot;)&#xa;&#xa;&#xa;    # Ретраи вручную, т.к. httpx не имеет встроенного Retry, как requests+urllib3&#xa;    attempts = RETRY_TOTAL + 1&#xa;    backoff = RETRY_BACKOFF&#xa;&#xa;&#xa;    t0 = time.perf_counter()&#xa;&#xa;&#xa;    async with httpx.AsyncClient(timeout=REQUEST_TIMEOUT) as client:&#xa;        for attempt in range(1, attempts + 1):&#xa;            try:&#xa;                resp = await client.post(url, headers=headers, json=payload)&#xa;                elapsed = time.perf_counter() - t0&#xa;&#xa;&#xa;                if resp.status_code == 200:&#xa;                    data = resp.json()&#xa;                    answer = data.get(&quot;answer&quot;, &quot;&quot;)&#xa;                    response_time = data.get(&quot;response_time&quot;, elapsed)&#xa;                    returned_uuid = data.get(&quot;external_uuid&quot;, external_uuid)&#xa;&#xa;&#xa;                    normalized_answer = _normalize_answer_text(answer)&#xa;                    log(&#xa;                        f&quot;IDP_SEARCH(async) ✔ 200 | time={response_time:.2f}s | uuid={returned_uuid} | &quot;&#xa;                        f&quot;answer_preview=&#39;{(normalized_answer or &#39;&#39;)[:180]}...&#39;&quot;,&#xa;                        level=&quot;INFO&quot;,&#xa;                    )&#xa;                    user.variables.set(&quot;IDP_answer&quot;, normalized_answer or &quot;&quot;)&#xa;                    user.variables.set(&quot;IDP_external_uuid&quot;, returned_uuid)&#xa;                    user.variables.set(&quot;IDP_response_time&quot;, response_time)&#xa;                    return&#xa;&#xa;&#xa;                if resp.status_code == 424:&#xa;                    err = resp.json()&#xa;                    err_desc = err.get(&quot;error_description&quot;, &quot;Ошибка при обращении к IDP&quot;)&#xa;                    err_code = err.get(&quot;error_code&quot;, &quot;IDP_REQUEST_ERROR&quot;)&#xa;                    response_time = err.get(&quot;response_time&quot;, elapsed)&#xa;&#xa;&#xa;                    log(f&quot;IDP_SEARCH(async) ✖ 424 | {err_code}: {err_desc} | time={response_time:.2f}s&quot;, level=&quot;ERROR&quot;)&#xa;                    user.variables.set(&quot;IDP_answer&quot;, f&quot;{err_desc} (код: {err_code})&quot;)&#xa;                    user.variables.set(&quot;IDP_external_uuid&quot;, external_uuid)&#xa;                    user.variables.set(&quot;IDP_response_time&quot;, response_time)&#xa;                    return&#xa;&#xa;&#xa;                # На 502/503/504 поделаем ретраи&#xa;                if resp.status_code in (502, 503, 504) and attempt &lt; attempts:&#xa;                    log(f&quot;IDP_SEARCH(async) ↻ retry {attempt}/{attempts-1} after {backoff:.1f}s (status {resp.status_code})&quot;)&#xa;                    await asyncio.sleep(backoff)&#xa;                    backoff *= 2&#xa;                    continue&#xa;&#xa;&#xa;                # Иначе — ошибка без ретрая&#xa;                body_preview = &quot;&quot;&#xa;                try:&#xa;                    body_preview = json.dumps(resp.json(), ensure_ascii=False)[:500]&#xa;                except Exception:&#xa;                    body_preview = (resp.text or &quot;&quot;)[:500]&#xa;&#xa;&#xa;                log(&#xa;                    f&quot;IDP_SEARCH(async) ✖ {resp.status_code} {resp.reason_phrase} | body=&#39;{body_preview}&#39;&quot;,&#xa;                    level=&quot;ERROR&quot;,&#xa;                )&#xa;                user.variables.set(&#xa;                    &quot;IDP_answer&quot;,&#xa;                    f&quot;Ошибка: {resp.status_code} {resp.reason_phrase}. Обратитесь к логам сервиса.&quot;,&#xa;                )&#xa;                user.variables.set(&quot;IDP_external_uuid&quot;, external_uuid)&#xa;                user.variables.set(&quot;IDP_response_time&quot;, elapsed)&#xa;                return&#xa;&#xa;&#xa;            except (httpx.TimeoutException, httpx.TransportError) as e:&#xa;                if attempt &lt; attempts:&#xa;                    log(f&quot;IDP_SEARCH(async) ↻ retry {attempt}/{attempts-1} after {backoff:.1f}s due to network error: {e}&quot;)&#xa;                    await asyncio.sleep(backoff)&#xa;                    backoff *= 2&#xa;                    continue&#xa;&#xa;&#xa;                elapsed = time.perf_counter() - t0&#xa;                log(f&quot;IDP_SEARCH(async) ⚠ network/timeout error: {str(e)}&quot;, level=&quot;ERROR&quot;)&#xa;                user.variables.set(&quot;IDP_answer&quot;, &quot;Сетевая ошибка при обращении к /idp_search&quot;)&#xa;                user.variables.set(&quot;IDP_external_uuid&quot;, external_uuid)&#xa;                user.variables.set(&quot;IDP_response_time&quot;, elapsed)&#xa;                return&#xa;&#xa;&#xa;&#xa;&#xa;if __name__ == &quot;__main__&quot;:&#xa;    # Пример запуска как у тебя, но через новый клиент&#xa;    questions = [&#xa;        &quot;Какие манипуляции с долгом возможны в отчетности?&quot;,&#xa;        &quot;По какому участнику сделки требуется построение прогноза движения денежных средств при установлении ИР на Консолидированную Группу?&quot;,&#xa;        &quot;На какой срок строятся будущие денежные потоки?&quot;,&#xa;        &quot;Как определить, что деятельность носит сезонный характер?&quot;,&#xa;        &quot;Можно ли строить будущие денежные потоки в иностранной валюте?&quot;,&#xa;        &quot;Относится ли к прочим изменениям увеличение срока действующей банковской гарантии?&quot;,&#xa;        &quot;Требуется ли проверка Fraud-риска по техническим изменениям?&quot;,&#xa;        &quot;Является ли прочим изменением продление периода выборки по сделке УФН?&quot;,&#xa;        &quot;Финансирует ли Банк казино?&quot;,&#xa;        &quot;Особенности финансирования по договорам простого товарищества&quot;,&#xa;        &quot;Может ли банк финансировать некоммерческие организации?&quot;,&#xa;    ]&#xa;&#xa;&#xa;    # Импорт твоей модели User остаётся прежним.&#xa;    # Ниже — простая заглушка. В реальном коде у тебя уже есть инстанс user.&#xa;    class _VarStore(dict):&#xa;        def set(self, k, v):&#xa;            self[k] = v&#xa;&#xa;&#xa;    class _User:&#xa;        def __init__(self):&#xa;            self.variables = _VarStore()&#xa;&#xa;&#xa;    for q in questions:&#xa;        u = _User()&#xa;        u.variables.set(&quot;IDP_question&quot;, q)&#xa;        run_idp_search(u)&#xa;        print(f&quot;Q: {q}\nA: {u.variables.get(&#39;IDP_answer&#39;)}\nUUID: {u.variables.get(&#39;IDP_external_uuid&#39;)}, &quot;&#xa;              f&quot;Time: {u.variables.get(&#39;IDP_response_time&#39;)}s\n{&#39;-&#39;*80}&quot;)" id="xQ9-_gr5QTslfE1LpaSg-1">
          <mxCell style="text;whiteSpace=wrap;" parent="1" vertex="1">
            <mxGeometry x="1710" y="480" width="560" height="6030" as="geometry" />
          </mxCell>
        </UserObject>
        <UserObject label="from datetime import datetime, timezone, timedelta&#xa;&#xa;&#xa;def request_time_header(offset_hours: int = 3) -&gt; str:&#xa;    &quot;&quot;&quot;Возвращает строку формата &#39;Request-Time: 2025-08-25T22:58:32.469340+03:00&#39;.&quot;&quot;&quot;&#xa;    tz = timezone(timedelta(hours=offset_hours))&#xa;    now = datetime.now(tz)  # TZ-aware&#xa;    # isoformat уже включает оффсет как +HH:MM, микросекунды идут по умолчанию&#xa;    return f&quot;Request-Time: {now.isoformat()}&quot;" link="from datetime import datetime, timezone, timedelta&#xa;&#xa;&#xa;def request_time_header(offset_hours: int = 3) -&gt; str:&#xa;    &quot;&quot;&quot;Возвращает строку формата &#39;Request-Time: 2025-08-25T22:58:32.469340+03:00&#39;.&quot;&quot;&quot;&#xa;    tz = timezone(timedelta(hours=offset_hours))&#xa;    now = datetime.now(tz)  # TZ-aware&#xa;    # isoformat уже включает оффсет как +HH:MM, микросекунды идут по умолчанию&#xa;    return f&quot;Request-Time: {now.isoformat()}&quot;" id="xQ9-_gr5QTslfE1LpaSg-2">
          <mxCell style="text;whiteSpace=wrap;" parent="1" vertex="1">
            <mxGeometry x="1460" y="700" width="520" height="150" as="geometry" />
          </mxCell>
        </UserObject>
        <UserObject label="Successfully removed standard-loguru logger with id 0&#xa;Displaying active handlers (4):&#xa; -- Handler id: 1 | Status: ready | Handler name: log-file-handler&#xa; -- Handler id: 2 | Status: ready | Handler name: metric-file-handler&#xa; -- Handler id: 3 | Status: ready | Handler name: audit-file-handler&#xa; -- Handler id: 4 | Status: ready | Handler name: log-console-handler&#xa;---------------- All handlers are ready, now loguru is in charge ----------------&#xa;INFO    | 2025-09-25 11:53:56.431 | aigw_service.context | App context initialized.&#xa;INFO    | 2025-09-25 11:53:56.563 | Started server process [23]&#xa;INFO    | 2025-09-25 11:53:56.564 | Waiting for application startup.&#xa;INFO    | 2025-09-25 11:53:56.564 | aigw_service.context | Application is starting up.&#xa;INFO    | 2025-09-25 11:53:56.565 | aigw_service.context | Attempt to connect to GigaChat at host http://gigachat-ift.sberdevices.delta.sbrf.ru:10500/v1.&#xa;INFO    | 2025-09-25 11:53:56.870 | aigw_service.context | Connection to GigaChat at host http://gigachat-ift.sberdevices.delta.sbrf.ru:10500/v1 successfully established.&#xa;INFO    | 2025-09-25 11:53:56.869 | HTTP Request: GET http://gigachat-ift.sberdevices.delta.sbrf.ru:10500/v1/models &quot;HTTP/1.1 200 OK&quot;&#xa;INFO    | 2025-09-25 11:53:56.871 | aigw_service.context | All connections checked. Application is up and ready.&#xa;INFO    | 2025-09-25 11:53:56.871 | Application startup complete.&#xa;INFO    | 2025-09-25 11:53:56.872 | Uvicorn running on http://0.0.0.0:8080 (Press CTRL+C to quit)&#xa;INFO    | 2025-09-25 11:54:01.598 |  | aigw_service.api.enhanced_logging_middleware | Incoming GET-request for /health&#xa;ERROR   | 2025-09-25 11:54:01.601 | Exception in ASGI application&#xa;  + Exception Group Traceback (most recent call last):&#xa;  |   File &quot;/opt/app-root/poetry-venv/lib64/python3.11/site-packages/starlette/_utils.py&quot;, line 76, in collapse_excgroups&#xa;  |     yield&#xa;  |   File &quot;/opt/app-root/poetry-venv/lib64/python3.11/site-packages/starlette/middleware/base.py&quot;, line 177, in __call__&#xa;  |     async with anyio.create_task_group() as task_group:&#xa;  |   File &quot;/opt/app-root/poetry-venv/lib64/python3.11/site-packages/anyio/_backends/_asyncio.py&quot;, line 781, in __aexit__&#xa;  |     raise BaseExceptionGroup(&#xa;  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)&#xa;  +-+---------------- 1 ----------------&#xa;    | Traceback (most recent call last):&#xa;    |   File &quot;/opt/app-root/poetry-venv/lib64/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py&quot;, line 403, in run_asgi&#xa;    |     result = await app(  # type: ignore[func-returns-value]&#xa;    |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^&#xa;    |   File &quot;/opt/app-root/poetry-venv/lib64/python3.11/site-packages/uvicorn/middleware/proxy_headers.py&quot;, line 60, in __call__&#xa;    |     return await self.app(scope, receive, send)&#xa;    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^&#xa;    |   File &quot;/opt/app-root/poetry-venv/lib64/python3.11/site-packages/fastapi/applications.py&quot;, line 1054, in __call__&#xa;    |     await super().__call__(scope, receive, send)&#xa;    |   File &quot;/opt/app-root/poetry-venv/lib64/python3.11/site-packages/starlette/applications.py&quot;, line 112, in __call__&#xa;    |     await self.middleware_stack(scope, receive, send)&#xa;    |   File &quot;/opt/app-root/poetry-venv/lib64/python3.11/site-packages/starlette/middleware/errors.py&quot;, line 187, in __call__&#xa;    |     raise exc&#xa;    |   File &quot;/opt/app-root/poetry-venv/lib64/python3.11/site-packages/starlette/middleware/errors.py&quot;, line 165, in __call__&#xa;    |     await self.app(scope, receive, _send)&#xa;    |   File &quot;/opt/app-root/poetry-venv/lib64/python3.11/site-packages/starlette/middleware/base.py&quot;, line 176, in __call__&#xa;    |     with recv_stream, send_stream, collapse_excgroups():&#xa;    |   File &quot;/usr/lib64/python3.11/contextlib.py&quot;, line 155, in __exit__&#xa;    |     self.gen.throw(typ, value, traceback)&#xa;    |   File &quot;/opt/app-root/poetry-venv/lib64/python3.11/site-packages/starlette/_utils.py&quot;, line 82, in collapse_excgroups&#xa;    |     raise exc&#xa;    |   File &quot;/opt/app-root/poetry-venv/lib64/python3.11/site-packages/starlette/middleware/base.py&quot;, line 178, in __call__&#xa;    |     response = await self.dispatch_func(request, call_next)&#xa;    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^&#xa;    |   File &quot;/opt/app-root/poetry-venv/lib64/python3.11/site-packages/aigw_service/api/enhanced_logging_middleware.py&quot;, line 190, in enhanced_log_requests&#xa;    |     logger.info(&#xa;    |   File &quot;/opt/app-root/poetry-venv/lib64/python3.11/site-packages/loguru/_logger.py&quot;, line 2078, in info&#xa;    |     __self._log(&quot;INFO&quot;, False, __self._options, __message, args, kwargs)&#xa;    |   File &quot;/opt/app-root/poetry-venv/lib64/python3.11/site-packages/loguru/_logger.py&quot;, line 2063, in _log&#xa;    |     patcher(log_record)&#xa;    |   File &quot;/opt/app-root/poetry-venv/lib64/python3.11/site-packages/aigw_service/logger/logger.py&quot;, line 100, in patching&#xa;    |     args.update({&quot;message&quot;: str(message), &quot;headers&quot;: str(args[&quot;headers&quot;])})&#xa;    |                                                          ~~~~^^^^^^^^^^^&#xa;    | KeyError: &#39;headers&#39;&#xa;    +------------------------------------&#xa;&#xa;&#xa;During handling of the above exception, another exception occurred:" link="Successfully removed standard-loguru logger with id 0&#xa;Displaying active handlers (4):&#xa; -- Handler id: 1 | Status: ready | Handler name: log-file-handler&#xa; -- Handler id: 2 | Status: ready | Handler name: metric-file-handler&#xa; -- Handler id: 3 | Status: ready | Handler name: audit-file-handler&#xa; -- Handler id: 4 | Status: ready | Handler name: log-console-handler&#xa;---------------- All handlers are ready, now loguru is in charge ----------------&#xa;INFO    | 2025-09-25 11:53:56.431 | aigw_service.context | App context initialized.&#xa;INFO    | 2025-09-25 11:53:56.563 | Started server process [23]&#xa;INFO    | 2025-09-25 11:53:56.564 | Waiting for application startup.&#xa;INFO    | 2025-09-25 11:53:56.564 | aigw_service.context | Application is starting up.&#xa;INFO    | 2025-09-25 11:53:56.565 | aigw_service.context | Attempt to connect to GigaChat at host http://gigachat-ift.sberdevices.delta.sbrf.ru:10500/v1.&#xa;INFO    | 2025-09-25 11:53:56.870 | aigw_service.context | Connection to GigaChat at host http://gigachat-ift.sberdevices.delta.sbrf.ru:10500/v1 successfully established.&#xa;INFO    | 2025-09-25 11:53:56.869 | HTTP Request: GET http://gigachat-ift.sberdevices.delta.sbrf.ru:10500/v1/models &quot;HTTP/1.1 200 OK&quot;&#xa;INFO    | 2025-09-25 11:53:56.871 | aigw_service.context | All connections checked. Application is up and ready.&#xa;INFO    | 2025-09-25 11:53:56.871 | Application startup complete.&#xa;INFO    | 2025-09-25 11:53:56.872 | Uvicorn running on http://0.0.0.0:8080 (Press CTRL+C to quit)&#xa;INFO    | 2025-09-25 11:54:01.598 |  | aigw_service.api.enhanced_logging_middleware | Incoming GET-request for /health&#xa;ERROR   | 2025-09-25 11:54:01.601 | Exception in ASGI application&#xa;  + Exception Group Traceback (most recent call last):&#xa;  |   File &quot;/opt/app-root/poetry-venv/lib64/python3.11/site-packages/starlette/_utils.py&quot;, line 76, in collapse_excgroups&#xa;  |     yield&#xa;  |   File &quot;/opt/app-root/poetry-venv/lib64/python3.11/site-packages/starlette/middleware/base.py&quot;, line 177, in __call__&#xa;  |     async with anyio.create_task_group() as task_group:&#xa;  |   File &quot;/opt/app-root/poetry-venv/lib64/python3.11/site-packages/anyio/_backends/_asyncio.py&quot;, line 781, in __aexit__&#xa;  |     raise BaseExceptionGroup(&#xa;  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)&#xa;  +-+---------------- 1 ----------------&#xa;    | Traceback (most recent call last):&#xa;    |   File &quot;/opt/app-root/poetry-venv/lib64/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py&quot;, line 403, in run_asgi&#xa;    |     result = await app(  # type: ignore[func-returns-value]&#xa;    |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^&#xa;    |   File &quot;/opt/app-root/poetry-venv/lib64/python3.11/site-packages/uvicorn/middleware/proxy_headers.py&quot;, line 60, in __call__&#xa;    |     return await self.app(scope, receive, send)&#xa;    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^&#xa;    |   File &quot;/opt/app-root/poetry-venv/lib64/python3.11/site-packages/fastapi/applications.py&quot;, line 1054, in __call__&#xa;    |     await super().__call__(scope, receive, send)&#xa;    |   File &quot;/opt/app-root/poetry-venv/lib64/python3.11/site-packages/starlette/applications.py&quot;, line 112, in __call__&#xa;    |     await self.middleware_stack(scope, receive, send)&#xa;    |   File &quot;/opt/app-root/poetry-venv/lib64/python3.11/site-packages/starlette/middleware/errors.py&quot;, line 187, in __call__&#xa;    |     raise exc&#xa;    |   File &quot;/opt/app-root/poetry-venv/lib64/python3.11/site-packages/starlette/middleware/errors.py&quot;, line 165, in __call__&#xa;    |     await self.app(scope, receive, _send)&#xa;    |   File &quot;/opt/app-root/poetry-venv/lib64/python3.11/site-packages/starlette/middleware/base.py&quot;, line 176, in __call__&#xa;    |     with recv_stream, send_stream, collapse_excgroups():&#xa;    |   File &quot;/usr/lib64/python3.11/contextlib.py&quot;, line 155, in __exit__&#xa;    |     self.gen.throw(typ, value, traceback)&#xa;    |   File &quot;/opt/app-root/poetry-venv/lib64/python3.11/site-packages/starlette/_utils.py&quot;, line 82, in collapse_excgroups&#xa;    |     raise exc&#xa;    |   File &quot;/opt/app-root/poetry-venv/lib64/python3.11/site-packages/starlette/middleware/base.py&quot;, line 178, in __call__&#xa;    |     response = await self.dispatch_func(request, call_next)&#xa;    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^&#xa;    |   File &quot;/opt/app-root/poetry-venv/lib64/python3.11/site-packages/aigw_service/api/enhanced_logging_middleware.py&quot;, line 190, in enhanced_log_requests&#xa;    |     logger.info(&#xa;    |   File &quot;/opt/app-root/poetry-venv/lib64/python3.11/site-packages/loguru/_logger.py&quot;, line 2078, in info&#xa;    |     __self._log(&quot;INFO&quot;, False, __self._options, __message, args, kwargs)&#xa;    |   File &quot;/opt/app-root/poetry-venv/lib64/python3.11/site-packages/loguru/_logger.py&quot;, line 2063, in _log&#xa;    |     patcher(log_record)&#xa;    |   File &quot;/opt/app-root/poetry-venv/lib64/python3.11/site-packages/aigw_service/logger/logger.py&quot;, line 100, in patching&#xa;    |     args.update({&quot;message&quot;: str(message), &quot;headers&quot;: str(args[&quot;headers&quot;])})&#xa;    |                                                          ~~~~^^^^^^^^^^^&#xa;    | KeyError: &#39;headers&#39;&#xa;    +------------------------------------&#xa;&#xa;&#xa;During handling of the above exception, another exception occurred:" id="pQdQ0HU5EwGSewBE9L3d-1">
          <mxCell style="text;whiteSpace=wrap;" parent="1" vertex="1">
            <mxGeometry x="60" y="110" width="560" height="1290" as="geometry" />
          </mxCell>
        </UserObject>
        <UserObject label="&lt;div style=&quot;color: #cccccc;background-color: #1f1f1f;font-family: &#39;Droid Sans Mono&#39;, &#39;monospace&#39;, monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #c586c0;&quot;&gt;import&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; uuid&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #c586c0;&quot;&gt;import&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; os&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #c586c0;&quot;&gt;import&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; requests&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #c586c0;&quot;&gt;from&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; datetime &lt;/span&gt;&lt;span style=&quot;color: #c586c0;&quot;&gt;import&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; datetime&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #c586c0;&quot;&gt;from&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; core.logging.logger_utils &lt;/span&gt;&lt;span style=&quot;color: #c586c0;&quot;&gt;import&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; log&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #c586c0;&quot;&gt;from&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; scenarios.user.user_model &lt;/span&gt;&lt;span style=&quot;color: #c586c0;&quot;&gt;import&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; User&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;def&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #dcdcaa;&quot;&gt;run_request&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #9cdcfe;&quot;&gt;service_id&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;: &lt;/span&gt;&lt;span style=&quot;color: #4ec9b0;&quot;&gt;str&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #9cdcfe;&quot;&gt;question&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;: &lt;/span&gt;&lt;span style=&quot;color: #4ec9b0;&quot;&gt;str&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;) -&amp;gt; &lt;/span&gt;&lt;span style=&quot;color: #4ec9b0;&quot;&gt;str&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;&quot;&quot;Отправляет запрос к серверу &quot;&quot;&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;    HEADERS &lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&#39;accept&#39;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;: &lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&#39;application/json&#39;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&#39;Content-Type&#39;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;: &lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&#39;application/json&#39;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;    }&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;    external_uuid &lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #4ec9b0;&quot;&gt;str&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;(uuid.uuid4())&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;    source_uuid &lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;9870147f-a646-4421-aa96-aa8960c821fb&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;    uri &lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; os.getenv(&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&#39;IDP_API&#39;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&#39;localhost:8080&#39;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;    uri &lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;r&lt;/span&gt;&lt;span style=&quot;color: #d16969;&quot;&gt;&quot;http://&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; uri &lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;r&lt;/span&gt;&lt;span style=&quot;color: #d16969;&quot;&gt;&quot;/sync/skill/dkpp_assistant&quot;&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;    request_body &lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;meta&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;: {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;external_uuid&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;: external_uuid,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;source_uuid&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;: source_uuid&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;        },&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;message&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;: {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;service_id&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;: service_id,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;messages&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;: [{&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;message_id&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;: &lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;1&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;message_dt&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;: datetime.now().isoformat(),  &lt;/span&gt;&lt;span style=&quot;color: #6a9955;&quot;&gt;# Актуальная дата и время&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;content&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;: question,  &lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;role&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;: &lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;user&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;            }]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;        },&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;timeout&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;: &lt;/span&gt;&lt;span style=&quot;color: #b5cea8;&quot;&gt;100&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;    }&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;    result &lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;None&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #c586c0;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;        log(&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;Отправка запроса к &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;uri&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt; | UID: &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;external_uuid&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt; | Вопрос: &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;question&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #9cdcfe;&quot;&gt;level&lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;INFO&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;        response &lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; requests.post(uri, &lt;/span&gt;&lt;span style=&quot;color: #9cdcfe;&quot;&gt;headers&lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;HEADERS, &lt;/span&gt;&lt;span style=&quot;color: #9cdcfe;&quot;&gt;json&lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;request_body, &lt;/span&gt;&lt;span style=&quot;color: #9cdcfe;&quot;&gt;verify&lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;True&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;        response.raise_for_status()&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #6a9955;&quot;&gt;# Сырый ответ логируем сразу&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;        raw_response &lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; response.text&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;        log(&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;Сырой ответ от &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;uri&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt; | UID: &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;external_uuid&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #d7ba7d;&quot;&gt;\n&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;raw_response&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #9cdcfe;&quot;&gt;level&lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;DEBUG&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #c586c0;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;            response_data &lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; response.json()&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;            messages &lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; response_data.get(&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;result&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;, {}).get(&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;messages&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;, [])&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #c586c0;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #dcdcaa;&quot;&gt;len&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;(messages) &lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b5cea8;&quot;&gt;2&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;or&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;not&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #dcdcaa;&quot;&gt;isinstance&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;(messages[&lt;/span&gt;&lt;span style=&quot;color: #b5cea8;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;], &lt;/span&gt;&lt;span style=&quot;color: #4ec9b0;&quot;&gt;dict&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;):&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #c586c0;&quot;&gt;raise&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #4ec9b0;&quot;&gt;IndexError&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;Ожидалось минимум два сообщения в &#39;messages&#39;, но получено меньше&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;            content_value &lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; messages[&lt;/span&gt;&lt;span style=&quot;color: #b5cea8;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;].get(&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;content&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #c586c0;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; content_value &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;is&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;None&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #c586c0;&quot;&gt;raise&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #4ec9b0;&quot;&gt;KeyError&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;Поле &#39;content&#39; отсутствует во втором элементе списка &#39;messages&#39;&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;            result &lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; content_value.replace(&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&#39;SOURCE&#39;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&#39;Источник - &#39;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;            log(&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;Успешный ответ от &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;uri&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt; | UID: &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;external_uuid&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt; | Система: &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;service_id&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #d7ba7d;&quot;&gt;\n&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;Вопрос: &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;question&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #d7ba7d;&quot;&gt;\n&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;Ответ: &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;result&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;, &lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #9cdcfe;&quot;&gt;level&lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;INFO&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;            )&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #c586c0;&quot;&gt;except&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; (&lt;/span&gt;&lt;span style=&quot;color: #4ec9b0;&quot;&gt;IndexError&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #4ec9b0;&quot;&gt;KeyError&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: #c586c0;&quot;&gt;as&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; parse_error:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;            log(&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;Ошибка обработки JSON от &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;uri&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt; | UID: &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;external_uuid&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt; | Ошибка: &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;parse_error&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #d7ba7d;&quot;&gt;\n&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;Сырой ответ: &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;raw_response&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;, &lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #9cdcfe;&quot;&gt;level&lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;ERROR&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;            )&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #c586c0;&quot;&gt;except&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; requests.RequestException &lt;/span&gt;&lt;span style=&quot;color: #c586c0;&quot;&gt;as&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; request_error:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;        log(&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;Ошибка при отправке POST-запроса к &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;uri&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt; | UID: &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;external_uuid&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt; | Ошибка: &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;request_error&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #d7ba7d;&quot;&gt;\n&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;Тело запроса: &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;request_body&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;, &lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #9cdcfe;&quot;&gt;level&lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;ERROR&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;        )&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #c586c0;&quot;&gt;except&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #4ec9b0;&quot;&gt;Exception&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #c586c0;&quot;&gt;as&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; unexpected_error:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;        log(&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;Непредвиденная ошибка при выполнении запроса к &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;uri&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt; | UID: &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;external_uuid&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt; | Ошибка: &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;unexpected_error&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #d7ba7d;&quot;&gt;\n&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #9cdcfe;&quot;&gt;level&lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;ERROR&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;        )&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #c586c0;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; result&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" link="&lt;div style=&quot;color: #cccccc;background-color: #1f1f1f;font-family: &#39;Droid Sans Mono&#39;, &#39;monospace&#39;, monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #c586c0;&quot;&gt;import&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; uuid&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #c586c0;&quot;&gt;import&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; os&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #c586c0;&quot;&gt;import&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; requests&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #c586c0;&quot;&gt;from&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; datetime &lt;/span&gt;&lt;span style=&quot;color: #c586c0;&quot;&gt;import&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; datetime&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #c586c0;&quot;&gt;from&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; core.logging.logger_utils &lt;/span&gt;&lt;span style=&quot;color: #c586c0;&quot;&gt;import&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; log&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #c586c0;&quot;&gt;from&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; scenarios.user.user_model &lt;/span&gt;&lt;span style=&quot;color: #c586c0;&quot;&gt;import&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; User&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;def&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #dcdcaa;&quot;&gt;run_request&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #9cdcfe;&quot;&gt;service_id&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;: &lt;/span&gt;&lt;span style=&quot;color: #4ec9b0;&quot;&gt;str&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #9cdcfe;&quot;&gt;question&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;: &lt;/span&gt;&lt;span style=&quot;color: #4ec9b0;&quot;&gt;str&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;) -&amp;gt; &lt;/span&gt;&lt;span style=&quot;color: #4ec9b0;&quot;&gt;str&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;&quot;&quot;Отправляет запрос к серверу &quot;&quot;&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;    HEADERS &lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&#39;accept&#39;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;: &lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&#39;application/json&#39;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&#39;Content-Type&#39;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;: &lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&#39;application/json&#39;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;    }&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;    external_uuid &lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #4ec9b0;&quot;&gt;str&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;(uuid.uuid4())&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;    source_uuid &lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;9870147f-a646-4421-aa96-aa8960c821fb&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;    uri &lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; os.getenv(&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&#39;IDP_API&#39;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&#39;localhost:8080&#39;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;    uri &lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;r&lt;/span&gt;&lt;span style=&quot;color: #d16969;&quot;&gt;&quot;http://&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; uri &lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;r&lt;/span&gt;&lt;span style=&quot;color: #d16969;&quot;&gt;&quot;/sync/skill/dkpp_assistant&quot;&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;    request_body &lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;meta&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;: {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;external_uuid&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;: external_uuid,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;source_uuid&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;: source_uuid&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;        },&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;message&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;: {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;service_id&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;: service_id,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;messages&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;: [{&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;message_id&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;: &lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;1&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;message_dt&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;: datetime.now().isoformat(),  &lt;/span&gt;&lt;span style=&quot;color: #6a9955;&quot;&gt;# Актуальная дата и время&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;content&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;: question,  &lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;role&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;: &lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;user&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;            }]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;        },&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;timeout&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;: &lt;/span&gt;&lt;span style=&quot;color: #b5cea8;&quot;&gt;100&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;    }&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;    result &lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;None&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #c586c0;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;        log(&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;Отправка запроса к &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;uri&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt; | UID: &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;external_uuid&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt; | Вопрос: &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;question&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #9cdcfe;&quot;&gt;level&lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;INFO&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;        response &lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; requests.post(uri, &lt;/span&gt;&lt;span style=&quot;color: #9cdcfe;&quot;&gt;headers&lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;HEADERS, &lt;/span&gt;&lt;span style=&quot;color: #9cdcfe;&quot;&gt;json&lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;request_body, &lt;/span&gt;&lt;span style=&quot;color: #9cdcfe;&quot;&gt;verify&lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;True&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;        response.raise_for_status()&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #6a9955;&quot;&gt;# Сырый ответ логируем сразу&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;        raw_response &lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; response.text&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;        log(&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;Сырой ответ от &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;uri&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt; | UID: &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;external_uuid&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #d7ba7d;&quot;&gt;\n&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;raw_response&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #9cdcfe;&quot;&gt;level&lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;DEBUG&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #c586c0;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;            response_data &lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; response.json()&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;            messages &lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; response_data.get(&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;result&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;, {}).get(&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;messages&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;, [])&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #c586c0;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #dcdcaa;&quot;&gt;len&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;(messages) &lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b5cea8;&quot;&gt;2&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;or&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;not&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #dcdcaa;&quot;&gt;isinstance&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;(messages[&lt;/span&gt;&lt;span style=&quot;color: #b5cea8;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;], &lt;/span&gt;&lt;span style=&quot;color: #4ec9b0;&quot;&gt;dict&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;):&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #c586c0;&quot;&gt;raise&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #4ec9b0;&quot;&gt;IndexError&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;Ожидалось минимум два сообщения в &#39;messages&#39;, но получено меньше&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;            content_value &lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; messages[&lt;/span&gt;&lt;span style=&quot;color: #b5cea8;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;].get(&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;content&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #c586c0;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; content_value &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;is&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;None&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #c586c0;&quot;&gt;raise&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #4ec9b0;&quot;&gt;KeyError&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;Поле &#39;content&#39; отсутствует во втором элементе списка &#39;messages&#39;&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;            result &lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; content_value.replace(&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&#39;SOURCE&#39;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&#39;Источник - &#39;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;            log(&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;Успешный ответ от &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;uri&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt; | UID: &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;external_uuid&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt; | Система: &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;service_id&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #d7ba7d;&quot;&gt;\n&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;Вопрос: &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;question&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #d7ba7d;&quot;&gt;\n&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;Ответ: &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;result&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;, &lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #9cdcfe;&quot;&gt;level&lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;INFO&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;            )&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;        &lt;/span&gt;&lt;span style=&quot;color: #c586c0;&quot;&gt;except&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; (&lt;/span&gt;&lt;span style=&quot;color: #4ec9b0;&quot;&gt;IndexError&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #4ec9b0;&quot;&gt;KeyError&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: #c586c0;&quot;&gt;as&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; parse_error:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;            log(&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;Ошибка обработки JSON от &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;uri&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt; | UID: &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;external_uuid&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt; | Ошибка: &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;parse_error&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #d7ba7d;&quot;&gt;\n&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;Сырой ответ: &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;raw_response&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;, &lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;                &lt;/span&gt;&lt;span style=&quot;color: #9cdcfe;&quot;&gt;level&lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;ERROR&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;            )&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #c586c0;&quot;&gt;except&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; requests.RequestException &lt;/span&gt;&lt;span style=&quot;color: #c586c0;&quot;&gt;as&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; request_error:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;        log(&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;Ошибка при отправке POST-запроса к &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;uri&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt; | UID: &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;external_uuid&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt; | Ошибка: &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;request_error&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #d7ba7d;&quot;&gt;\n&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;Тело запроса: &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;request_body&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;, &lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #9cdcfe;&quot;&gt;level&lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;ERROR&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;        )&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #c586c0;&quot;&gt;except&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #4ec9b0;&quot;&gt;Exception&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #c586c0;&quot;&gt;as&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; unexpected_error:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;        log(&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;Непредвиденная ошибка при выполнении запроса к &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;uri&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt; | UID: &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;external_uuid&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt; | Ошибка: &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;unexpected_error&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #d7ba7d;&quot;&gt;\n&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;            &lt;/span&gt;&lt;span style=&quot;color: #9cdcfe;&quot;&gt;level&lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&quot;ERROR&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;        )&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;    &lt;/span&gt;&lt;span style=&quot;color: #c586c0;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; result&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" id="pQdQ0HU5EwGSewBE9L3d-2">
          <mxCell style="text;whiteSpace=wrap;html=1;" parent="1" vertex="1">
            <mxGeometry x="570" y="10" width="560" height="1750" as="geometry" />
          </mxCell>
        </UserObject>
        <UserObject label="&lt;div style=&quot;color: #f8f8f2;background-color: #272822;font-family: Consolas, &#39;Courier New&#39;, monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;import&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; uuid&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;import&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; os&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;import&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; requests&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;from&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; datetime &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;import&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; datetime&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;from&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; core.logging.logger_utils &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;import&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; log&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;from&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; scenarios.user.user_model &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;import&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; User&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;def&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #a6e22e;&quot;&gt;run_request&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;service_id&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;: &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;str&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;question&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;: &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;str&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;) -&amp;gt; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;str&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&quot;&quot;Отправляет запрос к серверу &quot;&quot;&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;HEADERS&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&#39;accept&#39;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;: &lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&#39;application/json&#39;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&#39;Content-Type&#39;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;: &lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&#39;application/json&#39;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; external_uuid &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;str&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;(uuid.uuid4())&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; source_uuid &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;9870147f-a646-4421-aa96-aa8960c821fb&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #88846f;&quot;&gt;# Обязательные заголовки для API&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;HEADERS&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;Request-Id&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;] &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; external_uuid&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;HEADERS&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;Request-Time&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;] &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; datetime.now().isoformat()&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;HEADERS&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;System-Id&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;] &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; source_uuid&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; uri &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; os.getenv(&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&#39;IDP_API&#39;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&#39;localhost:8080&#39;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; uri &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;r&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;http://&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; uri &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;r&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;/api/v1/as_chat&quot;&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; as_name &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; service_id&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; request_body &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;as_name&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;: as_name,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;question&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;: question,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; result &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;None&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; log(&lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;Отправка запроса к &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;uri&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt; | UID: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;external_uuid&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt; | Вопрос: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;question&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;level&lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;INFO&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; response &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; requests.post(uri, &lt;/span&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;headers&lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;HEADERS&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;json&lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;request_body, &lt;/span&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;verify&lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;True&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; response.raise_for_status()&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #88846f;&quot;&gt;# Сырый ответ логируем сразу&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; raw_response &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; response.text&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; log(&lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;Сырой ответ от &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;uri&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt; | UID: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;external_uuid&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;\n{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;raw_response&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;level&lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;DEBUG&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; response_data &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; response.json()&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; content_value &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; response_data.get(&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;response&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; content_value &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;is&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;None&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;raise&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;KeyError&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;Поле &#39;response&#39; отсутствует в ответе API /api/v1/as_chat&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; result &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;str&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;(content_value).replace(&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&#39;SOURCE&#39;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&#39;Источник - &#39;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; log(&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;Успешный ответ от &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;uri&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt; | UID: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;external_uuid&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt; | Система: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;as_name&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}\n&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;Вопрос: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;question&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}\n&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;Ответ: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;result&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;, &lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;level&lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;INFO&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; )&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;except&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; (&lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;IndexError&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;KeyError&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;as&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; parse_error:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; log(&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;Ошибка обработки JSON от &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;uri&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt; | UID: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;external_uuid&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt; | Ошибка: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;parse_error&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}\n&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;Сырой ответ: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;raw_response&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;, &lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;level&lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;ERROR&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; )&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;except&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; requests.RequestException &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;as&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; request_error:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; log(&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;Ошибка при отправке POST-запроса к &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;uri&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt; | UID: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;external_uuid&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt; | Ошибка: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;request_error&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}\n&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;Тело запроса: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;request_body&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;, &lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;level&lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;ERROR&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; )&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;except&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;Exception&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;as&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; unexpected_error:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; log(&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;Непредвиденная ошибка при выполнении запроса к &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;uri&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt; | UID: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;external_uuid&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt; | Ошибка: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;unexpected_error&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}\n&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;level&lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;ERROR&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; )&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; result&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;/div&gt;" link="&lt;div style=&quot;color: #f8f8f2;background-color: #272822;font-family: Consolas, &#39;Courier New&#39;, monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;import&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; uuid&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;import&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; os&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;import&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; requests&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;from&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; datetime &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;import&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; datetime&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;from&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; core.logging.logger_utils &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;import&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; log&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;from&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; scenarios.user.user_model &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;import&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; User&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;def&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #a6e22e;&quot;&gt;run_request&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;service_id&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;: &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;str&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;question&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;: &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;str&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;) -&amp;gt; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;str&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&quot;&quot;Отправляет запрос к серверу &quot;&quot;&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;HEADERS&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&#39;accept&#39;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;: &lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&#39;application/json&#39;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&#39;Content-Type&#39;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;: &lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&#39;application/json&#39;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; external_uuid &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;str&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;(uuid.uuid4())&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; source_uuid &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;9870147f-a646-4421-aa96-aa8960c821fb&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #88846f;&quot;&gt;# Обязательные заголовки для API&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;HEADERS&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;Request-Id&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;] &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; external_uuid&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;HEADERS&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;Request-Time&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;] &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; datetime.now().isoformat()&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;HEADERS&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;System-Id&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;] &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; source_uuid&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; uri &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; os.getenv(&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&#39;IDP_API&#39;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&#39;localhost:8080&#39;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; uri &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;r&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;http://&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; uri &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;r&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;/api/v1/as_chat&quot;&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; as_name &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; service_id&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; request_body &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;as_name&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;: as_name,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;question&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;: question,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; result &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;None&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; log(&lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;Отправка запроса к &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;uri&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt; | UID: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;external_uuid&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt; | Вопрос: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;question&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;level&lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;INFO&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; response &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; requests.post(uri, &lt;/span&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;headers&lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;HEADERS&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;json&lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;request_body, &lt;/span&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;verify&lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;True&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; response.raise_for_status()&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #88846f;&quot;&gt;# Сырый ответ логируем сразу&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; raw_response &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; response.text&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; log(&lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;Сырой ответ от &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;uri&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt; | UID: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;external_uuid&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;:&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;\n{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;raw_response&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;level&lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;DEBUG&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; response_data &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; response.json()&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; content_value &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; response_data.get(&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;response&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; content_value &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;is&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;None&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;raise&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;KeyError&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;Поле &#39;response&#39; отсутствует в ответе API /api/v1/as_chat&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; result &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;str&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;(content_value).replace(&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&#39;SOURCE&#39;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&#39;Источник - &#39;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; log(&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;Успешный ответ от &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;uri&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt; | UID: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;external_uuid&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt; | Система: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;as_name&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}\n&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;Вопрос: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;question&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}\n&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;Ответ: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;result&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;, &lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;level&lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;INFO&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; )&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;except&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; (&lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;IndexError&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;, &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;KeyError&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;) &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;as&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; parse_error:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; log(&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;Ошибка обработки JSON от &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;uri&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt; | UID: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;external_uuid&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt; | Ошибка: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;parse_error&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}\n&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;Сырой ответ: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;raw_response&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;, &lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;level&lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;ERROR&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; )&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;except&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; requests.RequestException &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;as&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; request_error:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; log(&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;Ошибка при отправке POST-запроса к &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;uri&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt; | UID: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;external_uuid&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt; | Ошибка: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;request_error&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}\n&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;Тело запроса: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;request_body&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;, &lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;level&lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;ERROR&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; )&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;except&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;Exception&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;as&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; unexpected_error:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; log(&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;f&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;Непредвиденная ошибка при выполнении запроса к &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;uri&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt; | UID: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;external_uuid&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt; | Ошибка: &lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;unexpected_error&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;}\n&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;level&lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;ERROR&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; )&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #f8f8f2;&quot;&gt; result&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;/div&gt;" id="X9PzGbH588r5Txe9AsQ6-1">
          <mxCell style="text;whiteSpace=wrap;html=1;" parent="1" vertex="1">
            <mxGeometry x="60" y="40" width="560" height="1580" as="geometry" />
          </mxCell>
        </UserObject>
        <UserObject label="INFO    | 2025-09-26 09:30:50.869 | 268c8d59-584c-4577-a215-578ef0aa405f | aigw_service.api.enhanced_logging_middleware | Incoming POST-request for /api/v1/as_chat&#xa;INFO    | 2025-09-26 09:30:50.874 | 268c8d59-584c-4577-a215-578ef0aa405f | aigw_service.api.v1.router | AS chat request for &#39;efs&#39;: question length 23&#xa;INFO    | 2025-09-26 09:30:50.875 | 268c8d59-584c-4577-a215-578ef0aa405f | aigw_service.api.v1.service | AS chat request for &#39;efs&#39;: карточка тип территория...&#xa;INFO    | 2025-09-26 09:30:50.877 | 268c8d59-584c-4577-a215-578ef0aa405f | aigw_service.api.v1.service | Промпт для АС &#39;efs&#39; загружен успешно&#xa;INFO    | 2025-09-26 09:30:50.878 | 268c8d59-584c-4577-a215-578ef0aa405f | aigw_service.api.v1.service | История для АС &#39;efs&#39; загружена: 56 сообщений&#xa;INFO    | 2025-09-26 09:30:50.878 | 268c8d59-584c-4577-a215-578ef0aa405f | aigw_service.api.v1.service | Using 57 messages for AS &#39;efs&#39;&#xa;INFO    | 2025-09-26 09:30:50.879 | 268c8d59-584c-4577-a215-578ef0aa405f | aigw_service.api.v1.service | GigaChat request attempt 1, prompt length: 23, messages count: 57&#xa;INFO    | 2025-09-26 09:30:51.225 | HTTP Request: POST http://gigachat-ift.sberdevices.delta.sbrf.ru:10500/v1/chat/completions &quot;HTTP/1.1 404 Not Found&quot;&#xa;ERROR   | 2025-09-26 09:30:51.226 | 268c8d59-584c-4577-a215-578ef0aa405f | aigw_service.api.v1.service | GigaChat request failed: (URL(&#39;http://gigachat-ift.sberdevices.delta.sbrf.ru:10500/v1/chat/completions&#39;), 404, b&#39;{&quot;status&quot;:404,&quot;message&quot;:&quot;No such model&quot;}\n&#39;, Headers({&#39;access-control-allow-credentials&#39;: &#39;true&#39;, &#39;access-control-allow-headers&#39;: &#39;Origin, X-Requested-With, Content-Type, Accept, Authorization&#39;, &#39;access-control-allow-methods&#39;: &#39;GET, POST, DELETE, OPTIONS&#39;, &#39;access-control-allow-origin&#39;: &#39;https://beta.saluteai.sberdevices.ru&#39;, &#39;content-type&#39;: &#39;application/json; charset=utf-8&#39;, &#39;x-request-id&#39;: &#39;8485a410-2e1d-91b8-b51a-4ba8eb1437dc&#39;, &#39;x-session-id&#39;: &#39;221807fb-a250-428a-85da-e1f26096d6be&#39;, &#39;date&#39;: &#39;Fri, 26 Sep 2025 09:30:51 GMT&#39;, &#39;content-length&#39;: &#39;41&#39;, &#39;x-envoy-upstream-service-time&#39;: &#39;301&#39;, &#39;server&#39;: &#39;envoy&#39;}))&#xa;ERROR   | 2025-09-26 09:30:51.226 | 268c8d59-584c-4577-a215-578ef0aa405f | aigw_service.api.v1.router | AS chat failed: (URL(&#39;http://gigachat-ift.sberdevices.delta.sbrf.ru:10500/v1/chat/completions&#39;), 404, b&#39;{&quot;status&quot;:404,&quot;message&quot;:&quot;No such model&quot;}\n&#39;, Headers({&#39;access-control-allow-credentials&#39;: &#39;true&#39;, &#39;access-control-allow-headers&#39;: &#39;Origin, X-Requested-With, Content-Type, Accept, Authorization&#39;, &#39;access-control-allow-methods&#39;: &#39;GET, POST, DELETE, OPTIONS&#39;, &#39;access-control-allow-origin&#39;: &#39;https://beta.saluteai.sberdevices.ru&#39;, &#39;content-type&#39;: &#39;application/json; charset=utf-8&#39;, &#39;x-request-id&#39;: &#39;8485a410-2e1d-91b8-b51a-4ba8eb1437dc&#39;, &#39;x-session-id&#39;: &#39;221807fb-a250-428a-85da-e1f26096d6be&#39;, &#39;date&#39;: &#39;Fri, 26 Sep 2025 09:30:51 GMT&#39;, &#39;content-length&#39;: &#39;41&#39;, &#39;x-envoy-upstream-service-time&#39;: &#39;301&#39;, &#39;server&#39;: &#39;envoy&#39;}))&#xa;INFO    | 2025-09-26 09:30:51.227 | 268c8d59-584c-4577-a215-578ef0aa405f | aigw_service.api.enhanced_logging_middleware | Outgoing response to client system&#xa;INFO    | 2025-09-26 09:30:51.230 | 268c8d59-584c-4577-a215-578ef0aa405f | aigw_service.api.enhanced_logging_middleware | Request processing time for /api/v1/as_chat: 362 ms" link="INFO    | 2025-09-26 09:30:50.869 | 268c8d59-584c-4577-a215-578ef0aa405f | aigw_service.api.enhanced_logging_middleware | Incoming POST-request for /api/v1/as_chat&#xa;INFO    | 2025-09-26 09:30:50.874 | 268c8d59-584c-4577-a215-578ef0aa405f | aigw_service.api.v1.router | AS chat request for &#39;efs&#39;: question length 23&#xa;INFO    | 2025-09-26 09:30:50.875 | 268c8d59-584c-4577-a215-578ef0aa405f | aigw_service.api.v1.service | AS chat request for &#39;efs&#39;: карточка тип территория...&#xa;INFO    | 2025-09-26 09:30:50.877 | 268c8d59-584c-4577-a215-578ef0aa405f | aigw_service.api.v1.service | Промпт для АС &#39;efs&#39; загружен успешно&#xa;INFO    | 2025-09-26 09:30:50.878 | 268c8d59-584c-4577-a215-578ef0aa405f | aigw_service.api.v1.service | История для АС &#39;efs&#39; загружена: 56 сообщений&#xa;INFO    | 2025-09-26 09:30:50.878 | 268c8d59-584c-4577-a215-578ef0aa405f | aigw_service.api.v1.service | Using 57 messages for AS &#39;efs&#39;&#xa;INFO    | 2025-09-26 09:30:50.879 | 268c8d59-584c-4577-a215-578ef0aa405f | aigw_service.api.v1.service | GigaChat request attempt 1, prompt length: 23, messages count: 57&#xa;INFO    | 2025-09-26 09:30:51.225 | HTTP Request: POST http://gigachat-ift.sberdevices.delta.sbrf.ru:10500/v1/chat/completions &quot;HTTP/1.1 404 Not Found&quot;&#xa;ERROR   | 2025-09-26 09:30:51.226 | 268c8d59-584c-4577-a215-578ef0aa405f | aigw_service.api.v1.service | GigaChat request failed: (URL(&#39;http://gigachat-ift.sberdevices.delta.sbrf.ru:10500/v1/chat/completions&#39;), 404, b&#39;{&quot;status&quot;:404,&quot;message&quot;:&quot;No such model&quot;}\n&#39;, Headers({&#39;access-control-allow-credentials&#39;: &#39;true&#39;, &#39;access-control-allow-headers&#39;: &#39;Origin, X-Requested-With, Content-Type, Accept, Authorization&#39;, &#39;access-control-allow-methods&#39;: &#39;GET, POST, DELETE, OPTIONS&#39;, &#39;access-control-allow-origin&#39;: &#39;https://beta.saluteai.sberdevices.ru&#39;, &#39;content-type&#39;: &#39;application/json; charset=utf-8&#39;, &#39;x-request-id&#39;: &#39;8485a410-2e1d-91b8-b51a-4ba8eb1437dc&#39;, &#39;x-session-id&#39;: &#39;221807fb-a250-428a-85da-e1f26096d6be&#39;, &#39;date&#39;: &#39;Fri, 26 Sep 2025 09:30:51 GMT&#39;, &#39;content-length&#39;: &#39;41&#39;, &#39;x-envoy-upstream-service-time&#39;: &#39;301&#39;, &#39;server&#39;: &#39;envoy&#39;}))&#xa;ERROR   | 2025-09-26 09:30:51.226 | 268c8d59-584c-4577-a215-578ef0aa405f | aigw_service.api.v1.router | AS chat failed: (URL(&#39;http://gigachat-ift.sberdevices.delta.sbrf.ru:10500/v1/chat/completions&#39;), 404, b&#39;{&quot;status&quot;:404,&quot;message&quot;:&quot;No such model&quot;}\n&#39;, Headers({&#39;access-control-allow-credentials&#39;: &#39;true&#39;, &#39;access-control-allow-headers&#39;: &#39;Origin, X-Requested-With, Content-Type, Accept, Authorization&#39;, &#39;access-control-allow-methods&#39;: &#39;GET, POST, DELETE, OPTIONS&#39;, &#39;access-control-allow-origin&#39;: &#39;https://beta.saluteai.sberdevices.ru&#39;, &#39;content-type&#39;: &#39;application/json; charset=utf-8&#39;, &#39;x-request-id&#39;: &#39;8485a410-2e1d-91b8-b51a-4ba8eb1437dc&#39;, &#39;x-session-id&#39;: &#39;221807fb-a250-428a-85da-e1f26096d6be&#39;, &#39;date&#39;: &#39;Fri, 26 Sep 2025 09:30:51 GMT&#39;, &#39;content-length&#39;: &#39;41&#39;, &#39;x-envoy-upstream-service-time&#39;: &#39;301&#39;, &#39;server&#39;: &#39;envoy&#39;}))&#xa;INFO    | 2025-09-26 09:30:51.227 | 268c8d59-584c-4577-a215-578ef0aa405f | aigw_service.api.enhanced_logging_middleware | Outgoing response to client system&#xa;INFO    | 2025-09-26 09:30:51.230 | 268c8d59-584c-4577-a215-578ef0aa405f | aigw_service.api.enhanced_logging_middleware | Request processing time for /api/v1/as_chat: 362 ms" id="urF7iwsqGCduW3GBIU7J-1">
          <mxCell style="text;whiteSpace=wrap;" vertex="1" parent="1">
            <mxGeometry x="250" y="10" width="560" height="610" as="geometry" />
          </mxCell>
        </UserObject>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
